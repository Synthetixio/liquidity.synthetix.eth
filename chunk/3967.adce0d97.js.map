{"version":3,"file":"chunk/3967.adce0d97.js","mappings":"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","sources":["webpack://@snx-v3/staking-ui/../components/BorrowModal/BorrowModal.tsx","webpack://@snx-v3/staking-ui/../lib/useBorrow/useBorrow.tsx","webpack://@snx-v3/staking-ui/../components/BorrowModal/index.ts"],"sourcesContent":["import {\n  Box,\n  Button,\n  Flex,\n  Modal,\n  ModalBody,\n  ModalCloseButton,\n  ModalContent,\n  ModalHeader,\n  ModalOverlay,\n  Spinner,\n  Text,\n  useToast,\n} from '@chakra-ui/react';\nimport { Amount } from '@snx-v3/Amount';\nimport Wei from '@synthetixio/wei';\nimport { TransactionStatus } from '@snx-v3/txnReducer';\nimport { CheckIcon, CloseIcon } from '@snx-v3/Multistep';\nimport { PropsWithChildren, useCallback, useContext } from 'react';\nimport { useParams } from '@snx-v3/useParams';\nimport { ManagePositionContext } from '@snx-v3/ManagePositionContext';\nimport { useCollateralType } from '@snx-v3/useCollateralTypes';\nimport { useBorrow } from '@snx-v3/useBorrow';\nimport { useCoreProxy } from '@snx-v3/useCoreProxy';\nimport { useContractErrorParser } from '@snx-v3/useContractErrorParser';\nimport { ContractError } from '@snx-v3/ContractError';\nimport { useQueryClient } from '@tanstack/react-query';\nimport { useNetwork } from '@snx-v3/useBlockchain';\n\nfunction StepIcon({ txnStatus, children }: PropsWithChildren<{ txnStatus: TransactionStatus }>) {\n  switch (txnStatus) {\n    case 'error':\n      return <CloseIcon color=\"white\" />;\n    case 'success':\n      return <CheckIcon color=\"white\" />;\n    case 'prompting':\n    case 'pending':\n      return <Spinner color=\"white\" width={6} height={6} />;\n    default:\n      return (\n        <Box\n          __css={{\n            display: 'inline',\n            fontWeight: 'medium',\n            textAlign: 'center',\n            fontSize: 'md',\n          }}\n        >\n          {children}\n        </Box>\n      );\n  }\n}\n\nconst statusColor = (txnStatus: TransactionStatus) => {\n  if (txnStatus === 'error' || txnStatus === 'success') return txnStatus;\n  return 'gray.700';\n};\n\nexport const BorrowModalUi: React.FC<{\n  onClose: () => void;\n  debtChange: Wei;\n  isOpen: boolean;\n  txnStatus: TransactionStatus;\n  execBorrow: () => void;\n}> = ({ onClose, isOpen, debtChange, txnStatus, execBorrow }) => {\n  return (\n    <Modal size=\"lg\" isOpen={isOpen} onClose={onClose} closeOnOverlayClick={false}>\n      <ModalOverlay width=\"100%\" height=\"100%\" />\n      <ModalContent bg=\"black\" color=\"white\" data-testid=\"borrow modal\">\n        <ModalHeader>Complete this action</ModalHeader>\n        <ModalCloseButton />\n        <ModalBody>\n          <Flex\n            gap={2}\n            alignItems=\"center\"\n            rounded=\"lg\"\n            p=\"4\"\n            border=\"2px solid\"\n            transitionProperty=\"border-color\"\n            transitionDuration=\"normal\"\n            borderColor={statusColor(txnStatus)}\n          >\n            <Flex\n              width={10}\n              height={10}\n              justifyContent=\"center\"\n              alignItems=\"center\"\n              bg={statusColor(txnStatus)}\n              rounded=\"full\"\n              transitionProperty=\"background\"\n              transitionDuration=\"normal\"\n            >\n              <StepIcon txnStatus={txnStatus}>1</StepIcon>\n            </Flex>\n            <Text>\n              Borrow <Amount value={debtChange} suffix={` snxUSD`} />\n            </Text>\n          </Flex>\n          <Button\n            isDisabled={txnStatus === 'pending'}\n            onClick={() => {\n              if (txnStatus === 'unsent') {\n                execBorrow();\n              }\n              if (txnStatus === 'success') {\n                onClose();\n              }\n            }}\n            width=\"100%\"\n            my=\"4\"\n            data-testid=\"borrow confirm button\"\n          >\n            {(() => {\n              switch (txnStatus) {\n                case 'error':\n                  return 'Retry';\n                case 'pending':\n                  return 'Processing...';\n                case 'success':\n                  return 'Done';\n                default:\n                  return 'Start';\n              }\n            })()}\n          </Button>\n        </ModalBody>\n      </ModalContent>\n    </Modal>\n  );\n};\n\nexport const BorrowModal: React.FC<{\n  onClose: () => void;\n  isOpen: boolean;\n}> = ({ onClose, isOpen }) => {\n  const { debtChange } = useContext(ManagePositionContext);\n  const queryClient = useQueryClient();\n  const params = useParams();\n  const { data: collateralType } = useCollateralType(params.collateralSymbol);\n\n  const {\n    exec: execBorrow,\n    txnState,\n    settle: settleBorrow,\n  } = useBorrow({\n    accountId: params.accountId,\n    poolId: params.poolId,\n    collateralTypeAddress: collateralType?.tokenAddress,\n    debtChange,\n  });\n\n  const toast = useToast({ isClosable: true, duration: 9000 });\n  const { data: CoreProxy } = useCoreProxy();\n  const network = useNetwork();\n  const errorParserCoreProxy = useContractErrorParser(CoreProxy);\n  const execBorrowWithErrorParser = useCallback(async () => {\n    try {\n      await execBorrow();\n      await queryClient.invalidateQueries({\n        queryKey: [network.name, 'LiquidityPosition'],\n        exact: false,\n      });\n    } catch (error: any) {\n      const contractError = errorParserCoreProxy(error);\n      if (contractError) {\n        console.error(new Error(contractError.name), contractError);\n      }\n      toast.closeAll();\n      toast({\n        title: 'Borrow failed',\n        description: contractError ? (\n          <ContractError contractError={contractError} />\n        ) : (\n          'Please try again.'\n        ),\n        status: 'error',\n      });\n      throw Error('Borrow failed', { cause: error });\n    }\n  }, [errorParserCoreProxy, execBorrow, queryClient, toast, network.name]);\n\n  const { txnStatus } = txnState;\n  if (!params.poolId || !params.accountId || !collateralType) return null;\n  return (\n    <BorrowModalUi\n      execBorrow={execBorrowWithErrorParser}\n      debtChange={debtChange}\n      txnStatus={txnStatus}\n      onClose={() => {\n        settleBorrow();\n        onClose();\n      }}\n      isOpen={isOpen}\n    />\n  );\n};\n","import { useReducer } from 'react';\nimport { useCoreProxy } from '@snx-v3/useCoreProxy';\nimport { useMutation } from '@tanstack/react-query';\nimport { useNetwork, useProvider, useSigner } from '@snx-v3/useBlockchain';\nimport { initialState, reducer } from '@snx-v3/txnReducer';\nimport Wei from '@synthetixio/wei';\nimport { BigNumber } from 'ethers';\nimport { formatGasPriceForTransaction } from '@snx-v3/useGasOptions';\nimport { getGasPrice } from '@snx-v3/useGasPrice';\nimport { useGasSpeed } from '@snx-v3/useGasSpeed';\nimport { withERC7412 } from '@snx-v3/withERC7412';\nimport { useAllCollateralPriceIds } from '@snx-v3/useAllCollateralPriceIds';\nimport { fetchPriceUpdates, priceUpdatesToPopulatedTx } from '@snx-v3/fetchPythPrices';\n\nexport const useBorrow = ({\n  accountId,\n  poolId,\n  collateralTypeAddress,\n  debtChange,\n}: {\n  accountId?: string;\n  poolId?: string;\n  collateralTypeAddress?: string;\n  debtChange: Wei;\n}) => {\n  const [txnState, dispatch] = useReducer(reducer, initialState);\n  const { data: CoreProxy } = useCoreProxy();\n  const { data: collateralPriceIds } = useAllCollateralPriceIds();\n\n  const signer = useSigner();\n  const { gasSpeed } = useGasSpeed();\n  const provider = useProvider();\n  const network = useNetwork();\n\n  const mutation = useMutation({\n    mutationFn: async () => {\n      if (\n        !(signer && CoreProxy && poolId && accountId && collateralTypeAddress && collateralPriceIds)\n      )\n        return;\n      if (debtChange.eq(0)) return;\n\n      try {\n        dispatch({ type: 'prompting' });\n\n        const populatedTxnPromised = CoreProxy.populateTransaction.mintUsd(\n          BigNumber.from(accountId),\n          BigNumber.from(poolId),\n          collateralTypeAddress,\n          debtChange.toBN()\n        );\n        const walletAddress = await signer.getAddress();\n        const collateralPriceCallsPromise = fetchPriceUpdates(\n          collateralPriceIds,\n          network.isTestnet\n        ).then((signedData) =>\n          priceUpdatesToPopulatedTx(walletAddress, collateralPriceIds, signedData)\n        );\n\n        const [calls, gasPrices, collateralPriceCalls] = await Promise.all([\n          populatedTxnPromised,\n          getGasPrice({ provider }),\n          collateralPriceCallsPromise,\n        ]);\n        const allCalls = collateralPriceCalls.concat(calls);\n\n        const erc7412Tx = await withERC7412(provider, allCalls, 'borrow');\n\n        const gasOptionsForTransaction = formatGasPriceForTransaction({\n          gasLimit: erc7412Tx.gasLimit,\n          gasPrices,\n          gasSpeed,\n        });\n\n        const txn = await signer.sendTransaction({ ...erc7412Tx, ...gasOptionsForTransaction });\n\n        dispatch({ type: 'pending', payload: { txnHash: txn.hash } });\n\n        await txn.wait();\n        dispatch({ type: 'success' });\n      } catch (error: any) {\n        dispatch({ type: 'error', payload: { error } });\n        throw error;\n      }\n    },\n  });\n  return {\n    mutation,\n    txnState,\n    settle: () => dispatch({ type: 'settled' }),\n    isLoading: mutation.isLoading,\n    exec: mutation.mutateAsync,\n  };\n};\n","import { BorrowModal } from './BorrowModal';\nexport * from './BorrowModal';\nexport default BorrowModal;\n"],"names":["StepIcon","txnStatus","children","_jsx","CloseIcon","color","CheckIcon","Spinner","width","height","Box","__css","display","fontWeight","textAlign","fontSize","statusColor","BorrowModalUi","onClose","isOpen","debtChange","execBorrow","_jsxs","Modal","size","closeOnOverlayClick","ModalOverlay","ModalContent","bg","ModalHeader","ModalCloseButton","ModalBody","Flex","gap","alignItems","rounded","p","border","transitionProperty","transitionDuration","borderColor","justifyContent","Text","Amount","value","suffix","Button","isDisabled","onClick","my","BorrowModal","useContext","ManagePositionContext","queryClient","useQueryClient","params","useParams","data","collateralType","useCollateralType","collateralSymbol","exec","txnState","settle","settleBorrow","useBorrow","accountId","poolId","collateralTypeAddress","dispatch","useReducer","reducer","initialState","CoreProxy","useCoreProxy","collateralPriceIds","useAllCollateralPriceIds","signer","useSigner","gasSpeed","useGasSpeed","provider","useProvider","network","useNetwork","mutation","useMutation","mutationFn","async","eq","type","populatedTxnPromised","populateTransaction","mintUsd","BigNumber","from","toBN","walletAddress","getAddress","collateralPriceCallsPromise","fetchPriceUpdates","isTestnet","then","signedData","priceUpdatesToPopulatedTx","calls","gasPrices","collateralPriceCalls","Promise","all","getGasPrice","allCalls","concat","erc7412Tx","withERC7412","gasOptionsForTransaction","formatGasPriceForTransaction","gasLimit","txn","sendTransaction","payload","txnHash","hash","wait","error","isLoading","mutateAsync","tokenAddress","toast","useToast","isClosable","duration","errorParserCoreProxy","useContractErrorParser","execBorrowWithErrorParser","useCallback","invalidateQueries","queryKey","name","exact","contractError","console","Error","closeAll","title","description","ContractError","status","cause"],"sourceRoot":""}