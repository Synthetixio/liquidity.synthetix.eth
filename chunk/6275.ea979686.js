"use strict";(globalThis.webpackChunk_snx_v3_staking_ui=globalThis.webpackChunk_snx_v3_staking_ui||[]).push([[6275],{26275:(e,t,a)=>{a.r(t),a.d(t,{RepayModal:()=>te,RepayModalUi:()=>ee,default:()=>ae});var r=a(66901),s=a(26468),o=a(19433),n=a(54326),i=a(2338),l=a(97217),c=a(59176),p=a(84626),d=a(88115),u=a(45071),y=a(74774),h=a(2784),v=a(46160),f=a(40109),g=a(99),A=a(79634),m=a(61038),b=a(17716),x=a(10528),C=a(35834),w=a(95772),S=a(24269),R=a(37330),k=a(86848),E=a(42614),I=a(95522);var j=a(89536),P=a(13797),T=a(19299),q=a(97721),_=a(85649),U=a(97096),L=a(97737),O=a(9875),D=a(97386);const N="SET_REQUIRE_APPROVAL",B="SET_INFINITE_APPROVAL",M="RETRY",Q="RUN",$="RESET",F="idle",K="approve",z="repay",V="failed",Y="success",H={[K]:K,[z]:z},Z="approveSUSD",G="executeRepay",J={error:null,requireApproval:!1,infiniteApproval:!1},W=(0,O.C)({id:"RepayMachine",initial:F,predictableActionArguments:!0,context:J,on:{[Q]:{target:z,actions:(0,D.f0)({error:e=>J.error,requireApproval:e=>J.requireApproval,infiniteApproval:e=>J.infiniteApproval})},[N]:{actions:(0,D.f0)({requireApproval:(e,t)=>t.requireApproval})},[B]:{actions:(0,D.f0)({infiniteApproval:(e,t)=>t.infiniteApproval})}},states:{[F]:{on:{[Q]:[{target:K,cond:e=>e.requireApproval},{target:z}]}},[K]:{invoke:{src:Z,onDone:{target:z},onError:{target:V,actions:(0,D.f0)({error:(e,t)=>({error:t.data,step:H.approve})})}}},[z]:{invoke:{src:G,onDone:{target:Y},onError:{target:V,actions:(0,D.f0)({error:(e,t)=>({error:t.data,step:H.repay})})}}},[V]:{on:{[M]:[{target:K,cond:e=>e.error?.step===H.approve,actions:(0,D.f0)({error:e=>null})},{target:z,cond:e=>e.error?.step===H.repay,actions:(0,D.f0)({error:e=>null})}]}},[Y]:{}}});var X=a(52322);const ee=({onClose:e,isOpen:t,debtChange:a,state:d,onSubmit:h,setInfiniteApproval:v})=>{const f=d.matches(K)||d.matches(z),{infiniteApproval:g,requireApproval:A,error:m}=d.context;return(0,X.jsxs)(r.u_,{size:"lg",isOpen:t,onClose:e,closeOnOverlayClick:!1,children:[(0,X.jsx)(s.Z,{}),(0,X.jsxs)(o.h,{bg:"black",color:"white","data-testid":"repay modal",children:[(0,X.jsx)(n.x,{children:"Complete this action"}),(0,X.jsx)(i.o,{}),(0,X.jsxs)(l.f,{children:[(0,X.jsx)(y.P0,{step:1,title:"Approve sUSD transfer",status:{failed:m?.step===K,success:!A||d.matches(Y),loading:d.matches(K)&&!m},checkboxLabel:"Approve unlimited sUSD transfers to Synthetix.",checkboxProps:{isChecked:g,onChange:e=>v(e.target.checked)}}),(0,X.jsx)(y.P0,{step:2,title:"Repay",subtitle:(0,X.jsxs)(c.x,{children:["Repay ",(0,X.jsx)(u.$,{value:a.abs(),suffix:" sUSD"})]}),status:{failed:m?.step===z,success:d.matches(Y),loading:d.matches(z)&&!m}}),(0,X.jsx)(p.z,{isDisabled:f,onClick:h,width:"100%",my:"4","data-testid":"repay confirm button",children:(()=>{switch(!0){case Boolean(m):return"Retry";case f:return"Processing...";case d.matches(Y):return"Done";default:return"Start"}})()})]})]})]})},te=({onClose:e,isOpen:t,availableCollateral:a})=>{const{debtChange:r}=(0,h.useContext)(P.n),s=(0,j.UO)(),o=(0,m.LN)(),n=(0,A.useQueryClient)(),{data:i}=(0,S.a)(),{data:l}=(0,T.t)(s.collateralSymbol),{data:c}=(0,U.m)(i?.address),{exec:p,settle:u}=(({accountId:e,poolId:t,collateralTypeAddress:a,debtChange:r,balance:s,availableUSDCollateral:o})=>{const[n,i]=(0,h.useReducer)(b.I,b.E),{data:l}=(0,f.a)(),{data:c}=(0,S.a)(),{data:p}=(0,E.L)(),d=(0,m.mx)(),u=(0,m.LN)(),{gasSpeed:y}=(0,w.jU)(),v=(0,m.yL)(),j=(0,A.useMutation)({mutationFn:async()=>{if(!d)return;if(!(l&&t&&e&&a&&c&&p))return;if(!s)return;if(!o)return;if(r.eq(0))return;const n=r.abs(),h=n.sub(o);try{i({type:"prompting"});const r=h.lte(0)?void 0:l.populateTransaction.deposit(x.O$.from(e),c.address,h.toBN()),s=l.populateTransaction.burnUsd(x.O$.from(e),x.O$.from(t),a,n.toBN()),o=Promise.all([r,s].filter(R._)),f=await d.getAddress(),A=(0,I.$)(p,u.isTestnet).then((e=>(0,I.x)(f,p,e))),[m,b,w]=await Promise.all([o,(0,C.o)({provider:v}),A]),S=w.concat(m),E=await(0,k.dI)(v,S,"useRepay"),j=(0,g.F)({gasLimit:E.gasLimit,gasPrices:b,gasSpeed:y}),P=await d.sendTransaction({...E,...j});i({type:"pending",payload:{txnHash:P.hash}}),await P.wait(),i({type:"success"})}catch(e){throw i({type:"error",payload:{error:e}}),e}}});return{mutation:j,txnState:n,settle:()=>i({type:"settled"}),isLoading:j.isLoading,exec:j.mutateAsync}})({accountId:s.accountId,poolId:s.poolId,collateralTypeAddress:l?.tokenAddress,debtChange:r,availableUSDCollateral:a,balance:c}),y=(0,d.p)({isClosable:!0,duration:9e3}),{data:O}=(0,f.a)(),D=(0,q.o)(O),F=r.abs().sub(a||0),{approve:K,requireApproval:z}=(0,_.y)({contractAddress:i?.address,amount:F.toBN(),spender:O?.address}),[V,H]=(0,L.e)(W,{services:{[Z]:async()=>{try{y({title:"Approve sUSD for transfer",description:"The next transaction will repay your debt.",status:"info"}),await K(Boolean(V.context.infiniteApproval))}catch(e){const t=D(e);throw t&&console.error(new Error(t.name),t),y.closeAll(),y({title:"Approval failed",description:t?(0,X.jsx)(v.M,{contractError:t}):"Please try again.",status:"error"}),Error("Approve failed",{cause:e})}},[G]:async()=>{try{y.closeAll(),y({title:"Repaying..."}),await p(),await Promise.all([n.invalidateQueries({queryKey:[o.name,"TokenBalance"]}),n.invalidateQueries({queryKey:[o.name,"Allowance"]}),n.invalidateQueries({queryKey:[o.name,"LiquidityPosition"]})]),y.closeAll(),y({title:"Success",description:"Your debt has been repaid.",status:"success",duration:5e3})}catch(e){const t=D(e);throw t&&console.error(new Error(t.name),t),y({title:"Could not complete repaying",description:t?(0,X.jsx)(v.M,{contractError:t}):"Please try again.",status:"error"}),Error("Repay failed",{cause:e})}}}}),J=F.gt(0);(0,h.useEffect)((()=>{H(N,{requireApproval:z&&J})}),[J,z,H]);const te=(0,h.useCallback)((async()=>{if(V.matches(Y))return H($),void e();V.context.error?H(M):H(Q)}),[e,H,V]);return s.poolId&&s.accountId&&l?(0,X.jsx)(ee,{state:V,onSubmit:te,debtChange:r,setInfiniteApproval:e=>{H(B,{infiniteApproval:e})},onClose:()=>{u(),e()},isOpen:t}):null},ae=te}}]);
//# sourceMappingURL=6275.ea979686.js.map