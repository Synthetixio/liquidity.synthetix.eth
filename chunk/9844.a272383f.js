"use strict";(globalThis.webpackChunk_snx_v3_liquidity=globalThis.webpackChunk_snx_v3_liquidity||[]).push([[9844],{49844:(t,a,e)=>{e.r(a),e.d(a,{WithdrawModal:()=>D,WithdrawModalUi:()=>q,default:()=>F});var r=e(66901),s=e(26468),o=e(19433),n=e(54326),i=e(2338),l=e(97217),c=e(59176),d=e(84626),u=e(70065),w=e(2784),h=e(45071),p=e(47973),m=e(25042),E=e(89536),y=e(79929),T=e(9875),g=e(97386);const x={SET_AMOUNT:"SET_AMOUNT",SET_COLLATERAL_SYMBOL:"SET_COLLATERAL_SYMBOL",RETRY:"RETRY",RUN:"RUN",SUCCESS:"SUCCESS",FAILURE:"FAILURE",RESET:"RESET"},b={idle:"idle",withdraw:"withdraw",unwrap:"unwrap",failed:"failed",success:"success"},f={[b.withdraw]:b.withdraw,[b.unwrap]:b.unwrap},S={withdraw:"withdraw",unwrap:"unwrap"},C={amount:(0,y.wei)(0),error:null,collateralSymbol:void 0},R=(0,T.C)({id:"WithdrawMachine",initial:b.idle,predictableActionArguments:!0,context:C,on:{[x.RESET]:{target:b.idle,actions:(0,g.f0)({amount:t=>C.amount,error:t=>C.error,collateralSymbol:t=>C.collateralSymbol})},[x.SET_AMOUNT]:{actions:(0,g.f0)({amount:(t,a)=>a.amount})},[x.SET_COLLATERAL_SYMBOL]:{actions:(0,g.f0)({collateralSymbol:(t,a)=>a.symbol})}},states:{[b.idle]:{on:{[x.RUN]:[{target:b.withdraw,cond:t=>t.amount.gt(0)},{target:b.unwrap,cond:t=>t.amount.gt(0)&&"WETH"===t.collateralSymbol}]}},[b.withdraw]:{invoke:{src:S.withdraw,onError:{target:b.failed,actions:(0,g.f0)({error:(t,a)=>({error:a.data,step:f.withdraw})})},onDone:[{target:b.unwrap,cond:t=>"WETH"===t.collateralSymbol},{target:b.success}]}},[b.unwrap]:{invoke:{src:S.unwrap,onDone:{target:b.success},onError:{target:b.failed,actions:(0,g.f0)({error:(t,a)=>({error:a.data,step:f.unwrap})})}}},[b.failed]:{on:{[x.RETRY]:[{target:b.withdraw,cond:t=>t.error?.step===f.withdraw,actions:(0,g.f0)({error:t=>null})},{target:b.unwrap,cond:t=>t.error?.step===f.unwrap,actions:(0,g.f0)({error:t=>null})}]}},[b.success]:{}}});var A=e(97737),L=e(40109),v=e(28145),U=e(76885),O=e(17716),j=e(10528),_=e(99),k=e(35834),W=e(95772),M=e(51686),N=e(95522),H=e(86848);const P=({accountId:t,collateralTypeAddress:a,accountCollateral:e})=>{const[r,s]=(0,w.useReducer)(O.I,O.E),{data:o}=(0,L.a)(),{data:n}=(0,M.L)(),{network:i}=(0,U.LN)(),{gasSpeed:l}=(0,W.jU)(),c=(0,U.mx)(),d=(0,U.yL)(),u=(0,v.useMutation)({mutationFn:async()=>{if(!c||!i||!d)throw new Error("No signer or network");if(!(o&&a&&e?.availableCollateral&&n))return;if(e?.availableCollateral.eq(0))return;const r=await c.getAddress();try{s({type:"prompting"});const u=(0,k.o)({provider:d}),w=o.populateTransaction.withdraw(j.O$.from(t),a,e?.availableCollateral.toBN()),h=(0,N.$)(n,i.isTestnet).then((t=>(0,N.x)(r,n,t))),[p,m,E]=await Promise.all([u,w,h]),y=E.concat(m),T=await(0,H.dI)(i,y,"useWithdraw"),g=(0,_.F)({gasLimit:T.gasLimit,gasPrices:p,gasSpeed:l}),x=await c.sendTransaction({...T,...g});s({type:"pending",payload:{txnHash:x.hash}}),await x.wait(),s({type:"success"})}catch(t){throw s({type:"error",payload:{error:t}}),t}}});return{mutation:u,txnState:r,settle:()=>s({type:"settled"}),isLoading:u.isPending,exec:u.mutateAsync}};var $=e(97721),B=e(99581),I=e(50899),Y=e(52322);const q=({amount:t,isOpen:a,onClose:e,accountCollateral:u,onSubmit:w,state:p,error:E})=>{const y=p.matches(b.withdraw)||p.matches(b.unwrap);return(0,Y.jsxs)(r.u_,{size:"lg",isOpen:a,onClose:e,closeOnOverlayClick:!1,children:[(0,Y.jsx)(s.Z,{}),(0,Y.jsxs)(o.h,{bg:"black",color:"white","data-testid":"withdraw modal",children:[(0,Y.jsx)(I.$,{}),(0,Y.jsx)(n.x,{children:"Complete this action"}),(0,Y.jsx)(i.o,{}),(0,Y.jsxs)(l.f,{children:[(0,Y.jsx)(c.x,{mb:"2",children:"Please execute the following transactions:"}),(0,Y.jsx)(m.P0,{step:1,title:"Withdraw",subtitle:(0,Y.jsxs)(c.x,{as:"div",children:[(0,Y.jsx)(h.$,{value:t,suffix:` ${u?.symbol}`})," will be withdrawn"]}),status:{failed:Boolean(E?.step===b.withdraw),disabled:t.eq(0),success:p.matches(b.unwrap)||p.matches(b.success),loading:p.matches(b.withdraw)&&!E}}),"WETH"===u?.symbol?(0,Y.jsx)(m.P0,{step:2,title:`Unwrap ${u?.symbol}`,subtitle:"This will unwrap your WETH to ETH",status:{failed:Boolean(E?.step===b.unwrap),disabled:"WETH"!==u?.symbol,success:p.matches(b.success),loading:p.matches(b.unwrap)}}):null,(0,Y.jsx)(d.z,{isDisabled:y,onClick:w,width:"100%",my:"4","data-testid":"withdraw confirm button",children:(()=>{switch(!0){case Boolean(E):return"Retry";case y:return"Processing...";case p.matches(b.success):return"Done";default:return"Start"}})()})]})]})]})};function D({accountCollateral:t,onClose:a,isOpen:e}){const r=(0,E.UO)(),s=(0,u.p)({isClosable:!0,duration:9e3}),{network:o}=(0,U.LN)(),{exec:n}=(0,p.E)(),{exec:i}=P({accountId:r.accountId,collateralTypeAddress:t?.tokenAddress,accountCollateral:t}),l=(0,v.useQueryClient)(),{data:c}=(0,L.a)(),d=(0,$.o)(c),[h,m]=(0,A.e)(R,{context:{amount:t?.availableCollateral},services:{[S.withdraw]:async()=>{try{await i(),await l.invalidateQueries({queryKey:[`${o?.id}-${o?.preset}`,"AccountSpecificCollateral"]})}catch(t){const a=d(t);throw a&&console.error(new Error(a.name),a),s.closeAll(),s({title:"Withdraw failed",description:a?(0,Y.jsx)(B.M,{contractError:a}):"Please try again.",status:"error"}),Error("Withdraw failed",{cause:t})}},[S.unwrap]:async()=>{try{s({title:"Unwrap",description:"Unwrapping WETH to ETH.",status:"info"}),await n(h.context.amount)}catch(t){throw s.closeAll(),s({title:"Unwrap failed",description:"Please try again.",status:"error"}),Error("Unwrap failed",{cause:t})}}}}),y=(0,w.useCallback)((async()=>{if(h.matches(b.success))return m(x.RESET),void a();h.context.error?m(x.RETRY):m(x.RUN)}),[a,m,h]);return(0,Y.jsx)(q,{amount:h.context.amount,isOpen:e,onClose:a,accountCollateral:t,state:h,error:h.context.error,onSubmit:y})}const F=D}}]);
//# sourceMappingURL=9844.a272383f.js.map