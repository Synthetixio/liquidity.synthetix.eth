"use strict";(globalThis.webpackChunk_snx_v3_liquidity=globalThis.webpackChunk_snx_v3_liquidity||[]).push([[9844],{49844:(a,t,e)=>{e.r(t),e.d(t,{WithdrawModal:()=>D,WithdrawModalUi:()=>q,default:()=>F});var r=e(66901),s=e(26468),o=e(19433),n=e(54326),l=e(2338),i=e(97217),c=e(59176),d=e(84626),u=e(88115),w=e(2784),h=e(45071),p=e(47973),m=e(25042),E=e(89536),y=e(79929),T=e(9875),x=e(97386);const b={SET_AMOUNT:"SET_AMOUNT",SET_COLLATERAL_SYMBOL:"SET_COLLATERAL_SYMBOL",RETRY:"RETRY",RUN:"RUN",SUCCESS:"SUCCESS",FAILURE:"FAILURE",RESET:"RESET"},g={idle:"idle",withdraw:"withdraw",unwrap:"unwrap",failed:"failed",success:"success"},f={[g.withdraw]:g.withdraw,[g.unwrap]:g.unwrap},S={withdraw:"withdraw",unwrap:"unwrap"},C={amount:(0,y.wei)(0),error:null,collateralSymbol:void 0},R=(0,T.C)({id:"WithdrawMachine",initial:g.idle,predictableActionArguments:!0,context:C,on:{[b.RESET]:{target:g.idle,actions:(0,x.f0)({amount:a=>C.amount,error:a=>C.error,collateralSymbol:a=>C.collateralSymbol})},[b.SET_AMOUNT]:{actions:(0,x.f0)({amount:(a,t)=>t.amount})},[b.SET_COLLATERAL_SYMBOL]:{actions:(0,x.f0)({collateralSymbol:(a,t)=>t.symbol})}},states:{[g.idle]:{on:{[b.RUN]:[{target:g.withdraw,cond:a=>a.amount.gt(0)},{target:g.unwrap,cond:a=>a.amount.gt(0)&&"WETH"===a.collateralSymbol}]}},[g.withdraw]:{invoke:{src:S.withdraw,onError:{target:g.failed,actions:(0,x.f0)({error:(a,t)=>({error:t.data,step:f.withdraw})})},onDone:[{target:g.unwrap,cond:a=>"WETH"===a.collateralSymbol},{target:g.success}]}},[g.unwrap]:{invoke:{src:S.unwrap,onDone:{target:g.success},onError:{target:g.failed,actions:(0,x.f0)({error:(a,t)=>({error:t.data,step:f.unwrap})})}}},[g.failed]:{on:{[b.RETRY]:[{target:g.withdraw,cond:a=>a.error?.step===f.withdraw,actions:(0,x.f0)({error:a=>null})},{target:g.unwrap,cond:a=>a.error?.step===f.unwrap,actions:(0,x.f0)({error:a=>null})}]}},[g.success]:{}}});var L=e(97737),A=e(40109),v=e(79634),U=e(76885),O=e(17716),j=e(10528),_=e(99),W=e(35834),k=e(95772),M=e(51686),N=e(95522),H=e(86848);const P=({accountId:a,collateralTypeAddress:t,accountCollateral:e})=>{const[r,s]=(0,w.useReducer)(O.I,O.E),{data:o}=(0,A.a)(),{data:n}=(0,M.L)(),l=(0,U.LN)(),{gasSpeed:i}=(0,k.jU)(),c=(0,U.mx)(),d=(0,U.yL)(),u=(0,v.useMutation)({mutationFn:async()=>{if(!c)return;if(!(o&&t&&e?.availableCollateral&&n))return;if(e?.availableCollateral.eq(0))return;const r=await c.getAddress();try{s({type:"prompting"});const u=(0,W.o)({provider:d}),w=o.populateTransaction.withdraw(j.O$.from(a),t,e?.availableCollateral.toBN()),h=(0,N.$)(n,l.isTestnet).then((a=>(0,N.x)(r,n,a))),[p,m,E]=await Promise.all([u,w,h]),y=E.concat(m),T=await(0,H.dI)(d,y,"useWithdraw"),x=(0,_.F)({gasLimit:T.gasLimit,gasPrices:p,gasSpeed:i}),b=await c.sendTransaction({...T,...x});s({type:"pending",payload:{txnHash:b.hash}}),await b.wait(),s({type:"success"})}catch(a){throw s({type:"error",payload:{error:a}}),a}}});return{mutation:u,txnState:r,settle:()=>s({type:"settled"}),isLoading:u.isLoading,exec:u.mutateAsync}};var B=e(97721),I=e(99581),Y=e(50899),$=e(52322);const q=({amount:a,isOpen:t,onClose:e,accountCollateral:u,onSubmit:w,state:p,error:E})=>{const y=p.matches(g.withdraw)||p.matches(g.unwrap);return(0,$.jsxs)(r.u_,{size:"lg",isOpen:t,onClose:e,closeOnOverlayClick:!1,children:[(0,$.jsx)(s.Z,{}),(0,$.jsxs)(o.h,{bg:"black",color:"white","data-testid":"withdraw modal",children:[(0,$.jsx)(Y.$,{}),(0,$.jsx)(n.x,{children:"Complete this action"}),(0,$.jsx)(l.o,{}),(0,$.jsxs)(i.f,{children:[(0,$.jsx)(c.x,{mb:"2",children:"Please execute the following transactions:"}),(0,$.jsx)(m.P0,{step:1,title:"Withdraw",subtitle:(0,$.jsxs)(c.x,{as:"div",children:[(0,$.jsx)(h.$,{value:a,suffix:` ${u?.symbol}`})," will be withdrawn"]}),status:{failed:Boolean(E?.step===g.withdraw),disabled:a.eq(0),success:p.matches(g.unwrap)||p.matches(g.success),loading:p.matches(g.withdraw)&&!E}}),"WETH"===u?.symbol?(0,$.jsx)(m.P0,{step:2,title:`Unwrap ${u?.symbol}`,subtitle:"This will unwrap your WETH to ETH",status:{failed:Boolean(E?.step===g.unwrap),disabled:"WETH"!==u?.symbol,success:p.matches(g.success),loading:p.matches(g.unwrap)}}):null,(0,$.jsx)(d.z,{isDisabled:y,onClick:w,width:"100%",my:"4","data-testid":"withdraw confirm button",children:(()=>{switch(!0){case Boolean(E):return"Retry";case y:return"Processing...";case p.matches(g.success):return"Done";default:return"Start"}})()})]})]})]})};function D({accountCollateral:a,onClose:t,isOpen:e}){const r=(0,E.UO)(),s=(0,u.p)({isClosable:!0,duration:9e3}),o=(0,U.LN)(),{exec:n}=(0,p.E)(),{exec:l}=P({accountId:r.accountId,collateralTypeAddress:a?.tokenAddress,accountCollateral:a}),i=(0,v.useQueryClient)(),{data:c}=(0,A.a)(),d=(0,B.o)(c),[h,m]=(0,L.e)(R,{context:{amount:a?.availableCollateral},services:{[S.withdraw]:async()=>{try{await l(),await i.invalidateQueries({queryKey:[o.name,"AccountSpecificCollateral"]})}catch(a){const t=d(a);throw t&&console.error(new Error(t.name),t),s.closeAll(),s({title:"Withdraw failed",description:t?(0,$.jsx)(I.M,{contractError:t}):"Please try again.",status:"error"}),Error("Withdraw failed",{cause:a})}},[S.unwrap]:async()=>{try{s({title:"Unwrap",description:"Unwrapping WETH to ETH.",status:"info"}),await n(h.context.amount)}catch(a){throw s.closeAll(),s({title:"Unwrap failed",description:"Please try again.",status:"error"}),Error("Unwrap failed",{cause:a})}}}}),y=(0,w.useCallback)((async()=>{if(h.matches(g.success))return m(b.RESET),void t();h.context.error?m(b.RETRY):m(b.RUN)}),[t,m,h]);return(0,$.jsx)(q,{amount:h.context.amount,isOpen:e,onClose:t,accountCollateral:a,state:h,error:h.context.error,onSubmit:y})}const F=D}}]);
//# sourceMappingURL=9844.9e76b3a8.js.map