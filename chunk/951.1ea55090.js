"use strict";(globalThis.webpackChunk_snx_v3_liquidity=globalThis.webpackChunk_snx_v3_liquidity||[]).push([[951],{70951:(e,t,a)=>{a.r(t),a.d(t,{UndelegateModal:()=>J,UndelegateModalUi:()=>G,default:()=>V});var o=a(66901),l=a(26468),r=a(19433),s=a(54326),n=a(2338),i=a(97217),c=a(59176),d=a(84626),u=a(88115),m=a(2784),g=a(19299),p=a(45071),y=a(74774),h=a(79929),x=a(89536),b=a(9875),f=a(97386);const w="SET_AMOUNT",C="SET_COLLATERAL_SYMBOL",v="RETRY",S="RUN",T="RESET",j="idle",E="undelegate",L="failed",A="success",O={[E]:E},k="undelegate",R={amount:(0,h.wei)(0),error:null,collateralSymbol:void 0},_=(0,b.C)({id:"UndelegateMachine",initial:j,predictableActionArguments:!0,context:R,on:{[T]:{target:j,actions:(0,f.f0)({amount:e=>R.amount,error:e=>R.error,collateralSymbol:e=>R.collateralSymbol})},[w]:{actions:(0,f.f0)({amount:(e,t)=>t.amount})},[C]:{actions:(0,f.f0)({collateralSymbol:(e,t)=>t.symbol})}},states:{[j]:{on:{[S]:[{target:E,cond:e=>e.amount.gt(0)}]}},[E]:{invoke:{src:k,onError:{target:L,actions:(0,f.f0)({error:(e,t)=>({error:t.data,step:O.undelegate})})},onDone:[{target:A}]}},[L]:{on:{[v]:[{target:E,cond:e=>e.error?.step===O.undelegate,actions:(0,f.f0)({error:e=>null})}]}},[A]:{}}});var U=a(97737),q=a(40109),I=a(79634),P=a(61038),M=a(17716),N=a(10528),B=a(99),$=a(35834),D=a(95772),z=a(86848),F=a(42614),Q=a(95522);var Y=a(13797),H=a(97721),K=a(46160),Z=a(52322);const G=({amount:e,isOpen:t,onClose:a,collateralType:u,onSubmit:m,state:g,error:h})=>{const x=g.matches(E);return(0,Z.jsxs)(o.u_,{size:"lg",isOpen:t,onClose:a,closeOnOverlayClick:!1,children:[(0,Z.jsx)(l.Z,{}),(0,Z.jsxs)(r.h,{bg:"black",color:"white","data-testid":"undelegate modal",children:[(0,Z.jsx)(s.x,{children:"Complete this action"}),(0,Z.jsx)(n.o,{}),(0,Z.jsxs)(i.f,{children:[(0,Z.jsx)(c.x,{mb:"2",children:"Please execute the following transactions:"}),(0,Z.jsx)(y.P0,{step:1,title:"Remove collateral",subtitle:(0,Z.jsxs)(c.x,{as:"div",children:[(0,Z.jsx)(p.$,{value:e,suffix:` ${u?.symbol}`})," will be removed from the pool."]}),status:{failed:Boolean(h?.step===E),disabled:e.eq(0),success:g.matches(A),loading:g.matches(E)&&!h}}),(0,Z.jsx)(d.z,{isDisabled:x,onClick:m,width:"100%",my:"4","data-testid":"undelegate confirm button",children:(()=>{switch(!0){case Boolean(h):return"Retry";case x:return"Processing...";case g.matches(A):return"Done";default:return"Start"}})()})]})]})]})},J=({onClose:e,isOpen:t,liquidityPosition:a})=>{const o=(0,x.UO)(),{collateralChange:l}=(0,m.useContext)(Y.n),r=(0,P.LN)(),s=(0,I.useQueryClient)(),{data:n}=(0,g.t)(o.collateralSymbol),i=(0,u.p)({isClosable:!0,duration:9e3}),c=a?.collateralAmount||(0,h.wei)(0),{exec:d}=(({accountId:e,poolId:t,collateralTypeAddress:a,collateralChange:o,currentCollateral:l})=>{const[r,s]=(0,m.useReducer)(M.I,M.E),{data:n}=(0,q.a)(),i=(0,P.mx)(),{gasSpeed:c}=(0,D.jU)(),d=(0,P.yL)(),{data:u}=(0,F.L)(),g=(0,P.LN)(),p=(0,I.useMutation)({mutationFn:async()=>{if(i&&n&&t&&a&&u&&!o.eq(0)&&!l.eq(0))try{s({type:"prompting"});const r=n.populateTransaction.delegateCollateral(N.O$.from(e),N.O$.from(t),a,l.add(o).toBN(),(0,h.wei)(1).toBN()),m=await i.getAddress(),p=(0,Q.$)(u,g.isTestnet).then((e=>(0,Q.x)(m,u,e))),[y,x,b]=await Promise.all([r,(0,$.o)({provider:d}),p]),f=b.concat(y),w=await(0,z.dI)(d,f,"useUndelegate"),C=(0,B.F)({gasLimit:w.gasLimit,gasPrices:x,gasSpeed:c}),v=await i.sendTransaction({...w,...C});s({type:"pending",payload:{txnHash:v.hash}}),await v.wait(),s({type:"success"})}catch(e){throw s({type:"error",payload:{error:e}}),e}}});return{mutation:p,txnState:r,settle:()=>s({type:"settled"}),isLoading:p.isLoading,exec:p.mutateAsync}})({accountId:o.accountId,poolId:o.poolId,collateralTypeAddress:a?.tokenAddress,collateralChange:l,currentCollateral:c}),{data:p}=(0,q.a)(),y=(0,H.o)(p),[b,f]=(0,U.e)(_,{context:{amount:l.abs()},services:{[k]:async()=>{try{await d(),await s.invalidateQueries({queryKey:[r.name,"LiquidityPosition"],exact:!1})}catch(e){const t=y(e);throw t&&console.error(new Error(t.name),t),i.closeAll(),i({title:"Remove collateral failed",description:t?(0,Z.jsx)(K.M,{contractError:t}):"Please try again.",status:"error"}),Error("Remove collateral failed",{cause:e})}}}}),j=l.toString();(0,m.useEffect)((()=>{f(w,{amount:(0,h.wei)(j).abs()})}),[j,f]),(0,m.useEffect)((()=>{f(C,{symbol:(0,h.wei)(j).abs()})}),[j,f]);const E=(0,m.useCallback)((async()=>{if(b.matches(A))return f(T),void e();b.context.error?f(v):f(S)}),[e,f,b]);return(0,Z.jsx)(G,{amount:b.context.amount,isOpen:t,onClose:e,collateralType:n,state:b,error:b.context.error,onSubmit:E})},V=J}}]);
//# sourceMappingURL=951.1ea55090.js.map