"use strict";(globalThis.webpackChunk_snx_v3_liquidity=globalThis.webpackChunk_snx_v3_liquidity||[]).push([[1984],{91984:(e,t,a)=>{a.r(t),a.d(t,{RepayModal:()=>le,RepayModalUi:()=>ie,default:()=>ce});var r=a(75429),o=a(11082),s=a(59176),n=a(74008),i=a(84626),l=a(70065),c=a(38035),d=a(56317),p=a(45071),u=a(42219),h=a(99581),y=a(96596),v=a(77528),f=a(13797),b=a(25042),g=a(42383),x=a(908),m=a(63322),A=a(8176),w=a(22668),C=a(34367),j=a(89536),S=a(18498),T=a(37330),k=a(17716),E=a(68881),I=a(99),R=a(35834),P=a(95772),$=a(20870),q=a(89990),D=a(37888),O=a(28145),U=a(10528),_=a(50986),N=a(51906),L=a(2784);var B=a(5348),M=a(97737),H=a(21849),z=a(9875),Y=a(97386);const F="SET_REQUIRE_APPROVAL",Q="SET_INFINITE_APPROVAL",K="RETRY",V="RUN",W="RESET",G="idle",X="approve",J="repay",Z="failed",ee="success",te={[X]:X,[J]:J},ae="approveSUSD",re="executeRepay",oe={error:null,requireApproval:!1,infiniteApproval:!1},se=(0,z.C)({id:"RepayMachine",initial:G,predictableActionArguments:!0,context:oe,on:{[V]:{target:J,actions:(0,Y.f0)({error:e=>oe.error,requireApproval:e=>oe.requireApproval,infiniteApproval:e=>oe.infiniteApproval})},[F]:{actions:(0,Y.f0)({requireApproval:(e,t)=>t.requireApproval})},[Q]:{actions:(0,Y.f0)({infiniteApproval:(e,t)=>t.infiniteApproval})}},states:{[G]:{on:{[V]:[{target:X,cond:e=>e.requireApproval},{target:J}]}},[X]:{invoke:{src:ae,onDone:{target:J},onError:{target:Z,actions:(0,Y.f0)({error:(e,t)=>({error:t.data,step:te.approve})})}}},[J]:{invoke:{src:re,onDone:{target:ee},onError:{target:Z,actions:(0,Y.f0)({error:(e,t)=>({error:t.data,step:te.repay})})}}},[Z]:{on:{[K]:[{target:X,cond:e=>e.error?.step===te.approve,actions:(0,Y.f0)({error:e=>null})},{target:J,cond:e=>e.error?.step===te.repay,actions:(0,Y.f0)({error:e=>null})}]}},[ee]:{}}});var ne=a(52322);const ie=({symbol:e,onClose:t,isOpen:a,debtChange:l,state:c,onSubmit:d,setInfiniteApproval:u})=>{const h=c.matches(X)||c.matches(J),{infiniteApproval:y,requireApproval:v,error:f}=c.context;if(a)return c.matches(ee)?(0,ne.jsx)(H.s,{onClose:d,title:"Debt successfully Updated",subline:(0,ne.jsxs)(ne.Fragment,{children:["Your ",(0,ne.jsx)("b",{children:"Debt"})," has been updated, read more about it in the"," ",(0,ne.jsx)(o.r,{href:"https://docs.synthetix.io/v/synthetix-v3-user-documentation",target:"_blank",color:"cyan.500",children:"Synthetix V3 Documentation"})]}),alertText:(0,ne.jsxs)(ne.Fragment,{children:[(0,ne.jsx)("b",{children:"Debt"})," successfully Updated"]})}):(0,ne.jsxs)("div",{"data-cy":"repay multistep",children:[(0,ne.jsxs)(s.x,{color:"gray.50",fontSize:"20px",fontWeight:700,children:[(0,ne.jsx)(r.R,{cursor:"pointer",onClick:t,mr:2}),"Manage Debt"]}),(0,ne.jsx)(n.i,{my:4}),(0,ne.jsx)(b.P0,{step:1,title:`Approve ${e} transfer`,status:{failed:f?.step===X,success:!v||c.matches(ee),loading:c.matches(X)&&!f},checkboxLabel:v?`Approve unlimited ${e} transfers to Synthetix.`:void 0,checkboxProps:{isChecked:y,onChange:e=>u(e.target.checked)}}),(0,ne.jsx)(b.P0,{step:2,title:"Repay",subtitle:(0,ne.jsxs)(s.x,{children:["Repay ",(0,ne.jsx)(p.$,{value:l.abs(),suffix:` ${e}`})]}),status:{failed:f?.step===J,success:c.matches(ee),loading:c.matches(J)&&!f}}),(0,ne.jsx)(i.z,{isDisabled:h,onClick:d,width:"100%",mt:"6","data-cy":"repay confirm button",children:(()=>{switch(!0){case Boolean(f):return"Retry";case h:return"Processing...";case c.matches(ee):return"Continue";default:return"Execute Transaction"}})()})]})},le=({onClose:e,isOpen:t,availableCollateral:a})=>{const{debtChange:r,setDebtChange:o}=(0,L.useContext)(f.n),s=(0,j.UO)(),{network:i}=(0,x.LN)(),p=(0,O.useQueryClient)(),{data:b}=(0,m.t)(s.collateralSymbol),{data:H}=(0,q.p)(),{data:z}=(0,B.mM)(H?.address),{exec:Y,settle:G}=(0,S.f)({accountId:s.accountId,poolId:s.poolId,collateralTypeAddress:b?.tokenAddress,debtChange:r,availableUSDCollateral:a,balance:z}),{exec:X,settle:J}=(({accountId:e,poolId:t,collateralTypeAddress:a,debtChange:r,availableUSDCollateral:o,collateralSymbol:s})=>{const[n,i]=(0,L.useReducer)(k.I,k.E),{data:l}=(0,w.a)(),{data:c}=(0,q.p)(),{data:d}=(0,$.b)(),{data:p,refetch:u}=(0,E.Y_)(),{data:h}=(0,C.X)(),f=(0,x.mx)(),{network:b}=(0,x.LN)(),{gasSpeed:m}=(0,P.jU)(),A=(0,x.yL)(),j=(0,O.useMutation)({mutationFn:async()=>{if(!f||!b||!A)throw new Error("No signer or network");if(!(l&&t&&e&&a&&c&&d&&h?.sUSD))return;if(!o)return;if(r.eq(0))return;const n=r.abs(),u=n.sub(o),x=u.gt(0)?(0,y.vz)(u.toString(),6):U.O$.from(0);try{i({type:"prompting"});const r=(0,v.$l)(s),o=new _.CH(d.address,d.abi,f),h=x.gt(0)?o.populateTransaction.wrap(r,x,0):void 0,y=new _.CH(a,g.P,f),w=u.gt(0)?y.populateTransaction.approve(d.address,u.toBN()):void 0,C=u.gt(0)?o.populateTransaction.sell(r,u.toBN(),0,N.d):void 0,j=new _.CH(c.address,g.P,f),S=u.gt(0)?j.populateTransaction.approve(l.address,u.toBN()):void 0,k=new _.CH(l.address,l.abi,f),E=u.lte(0)?void 0:k.populateTransaction.deposit(U.O$.from(e),c.address,u.toBN()),P=k.populateTransaction.burnUsd(U.O$.from(e),U.O$.from(t),a,n.toBN()),$=Promise.all([h,w,C,S,E,P].filter(T._)),[q,O]=await Promise.all([$,(0,R.o)({provider:A})]);p&&q.unshift(p);const L=await f.getAddress(),{multicallTxn:B,gasLimit:M}=await(0,D.dI)(b,q,"useRepay",L),H=(0,I.F)({gasLimit:M,gasPrices:O,gasSpeed:m}),z=await f.sendTransaction({...B,...H});i({type:"pending",payload:{txnHash:z.hash}}),await z.wait(),i({type:"success"})}catch(e){throw i({type:"error",payload:{error:e}}),e}},onSuccess:()=>{u()}});return{mutation:j,txnState:n,settle:()=>i({type:"settled"}),isLoading:j.isPending,exec:j.mutateAsync}})({accountId:s.accountId,poolId:s.poolId,collateralTypeAddress:b?.tokenAddress,debtChange:r,availableUSDCollateral:a}),Z=(0,l.p)({isClosable:!0,duration:9e3}),{data:te}=(0,w.a)(),{data:oe}=(0,$.b)(),le=(0,A.o)(),ce=r.abs().sub(a||0),{data:de}=(0,C.H)((0,v.$l)(s.collateralSymbol)),pe=(0,v.Yz)(i?.id,i?.preset),ue=pe?de:H?.address,{approve:he,requireApproval:ye}=(0,g.y)({contractAddress:ue,amount:pe?(0,y.vz)(ce.toString(),6):ce.toBN(),spender:pe?oe?.address:te?.address}),[ve,fe]=(0,M.e)(se,{services:{[ae]:async()=>{try{Z({title:`Approve ${H?.symbol} for transfer`,description:"The next transaction will repay your debt.",status:"info",variant:"left-accent"}),await he(Boolean(ve.context.infiniteApproval))}catch(e){const t=le(e);throw t&&console.error(new Error(t.name),t),Z.closeAll(),Z({title:"Approval failed",description:t?(0,ne.jsx)(h.M,{contractError:t}):"Please try again.",status:"error",variant:"left-accent",duration:36e5}),Error("Approve failed",{cause:e})}},[re]:async()=>{try{Z.closeAll(),Z({title:"Repaying...",variant:"left-accent"}),(0,v.Yz)(i?.id,i?.preset)?await X():await Y(),await Promise.all([p.invalidateQueries({queryKey:[`${i?.id}-${i?.preset}`,"TokenBalance"]}),p.invalidateQueries({queryKey:[`${i?.id}-${i?.preset}`,"Allowance"]}),p.invalidateQueries({queryKey:[`${i?.id}-${i?.preset}`,"LiquidityPosition"]})]),o(u.GH),Z.closeAll(),Z({title:"Success",description:"Your debt has been repaid.",status:"success",duration:5e3,variant:"left-accent"})}catch(e){const t=le(e);throw t&&console.error(new Error(t.name),t),Z({title:"Could not complete repaying",description:t?(0,ne.jsx)(h.M,{contractError:t}):"Please try again.",status:"error",variant:"left-accent",duration:36e5}),Error("Repay failed",{cause:e})}}}}),be=ce.gt(0);(0,L.useEffect)((()=>{fe(F,{requireApproval:ye&&be})}),[be,ye,fe]);const ge=(0,L.useCallback)((async()=>{if(ve.matches(ee))return fe(W),void e();ve.context.error?fe(K):fe(V)}),[e,fe,ve]);return s.poolId&&s.accountId&&b&&H?(0,ne.jsx)(ie,{state:ve,onSubmit:ge,debtChange:r,setInfiniteApproval:e=>{fe(Q,{infiniteApproval:e})},onClose:()=>{G(),J(),e()},isOpen:t,symbol:pe?b.symbol:H?.symbol}):(0,ne.jsxs)(c.k,{gap:4,flexDirection:"column",children:[(0,ne.jsx)(d.O,{maxW:"232px",width:"100%",height:"20px"}),(0,ne.jsx)(n.i,{my:4}),(0,ne.jsx)(d.O,{width:"100%",height:"20px"}),(0,ne.jsx)(d.O,{width:"100%",height:"20px"})]})},ce=le}}]);
//# sourceMappingURL=1984.a62ab974.js.map