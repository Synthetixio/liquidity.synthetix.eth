"use strict";(globalThis.webpackChunk_snx_v3_liquidity=globalThis.webpackChunk_snx_v3_liquidity||[]).push([[7665],{17665:(t,a,e)=>{e.r(a),e.d(a,{WithdrawModal:()=>K,WithdrawModalUi:()=>G,default:()=>z});var s=e(11082),r=e(59176),o=e(74008),i=e(84626),n=e(70065),l=e(2784),d=e(25042),c=e(40109),u=e(28145),p=e(76885),w=e(17716),y=e(50986),h=e(10528),m=e(99),g=e(35834),b=e(95772),x=e(42614),v=e(95522),C=e(40987),f=e(96596);const S=({accountId:t,collateralTypeAddress:a,amount:e})=>{const[s,r]=(0,l.useReducer)(w.I,w.E),{data:o}=(0,c.a)(),{data:i}=(0,x.L)(),{network:n}=(0,p.LN)(),{gasSpeed:d}=(0,b.jU)(),S=(0,p.mx)(),T=(0,p.yL)(),j=(0,u.useMutation)({mutationFn:async()=>{if(!S||!n||!T)throw new Error("No signer or network");if(!(o&&a&&e&&i))throw new Error("Not ready");if(e?.eq(0))throw new Error("Amount less than 0");const s=await S.getAddress();try{r({type:"prompting"});const l=(0,g.o)({provider:T}),c=new y.CH(a,["function decimals() view returns (uint8)"],T),u=await c.decimals(),p=e.gt(0)?(0,f.vz)(e.toString(),u):h.O$.from(0),w=o.populateTransaction.withdraw(h.O$.from(t),a,p),b=(0,v.$)(i,n.isTestnet).then((t=>(0,v.x)(s,i,t))),[x,j,k]=await Promise.all([l,w,b]),A=k.concat(j),$=await(0,C.dI)(n,A,"useWithdraw",s),D=(0,m.F)({gasLimit:$.gasLimit,gasPrices:x,gasSpeed:d}),W=await S.sendTransaction({...$,...D});r({type:"pending",payload:{txnHash:W.hash}}),await W.wait(),r({type:"success"})}catch(t){throw r({type:"error",payload:{error:t}}),t}}});return{mutation:j,txnState:s,settle:()=>r({type:"settled"}),isLoading:j.isPending,exec:j.mutateAsync}};var T=e(1492),j=e(97721),k=e(99581),A=e(75429),$=e(21849),D=e(77528),W=e(42219),N=e(51906),E=e(49494),I=e(7226),L=e(37330),q=e(44243),P=e(82227),U=e(34367);const B=({accountId:t,availableCollateral:a,snxUSDCollateral:e,amountToWithdraw:s,accountCollateral:r,collateralSymbol:o})=>{const[i,n]=(0,l.useReducer)(w.I,w.E),{data:d}=(0,c.a)(),{data:y}=(0,I.b)(),{data:x}=(0,q.a)(),{data:v}=(0,P.Y_)(),{network:f}=(0,p.LN)(),{data:S}=(0,U.X)(),{gasSpeed:T}=(0,b.jU)(),j=(0,p.mx)(),k=(0,p.yL)(),A=(0,u.useMutation)({mutationFn:async()=>{if(!j||!f||!k)throw new Error("No signer or network");if(!(d&&y&&t&&S?.sUSD&&S.snxUSD))throw new Error("Not ready");if(e.add(a).lt(s))throw new Error("Exceeds balance");const i=s.gt(a)?a:s,l=s.sub(i).gt(0)?s.sub(i):W.GH;try{const e=(0,D.$l)(o);n({type:"prompting"});const s=(0,g.o)({provider:k}),c=i.gt(0)?d.populateTransaction.withdraw(h.O$.from(t),r?.tokenAddress,i.toBN()):void 0,u=l.gt(0)?d.populateTransaction.withdraw(h.O$.from(t),S?.snxUSD,l.toBN()):void 0,p=l.gt(0)?x?.populateTransaction.approve(y.address,l.toBN()):void 0,w=l.gt(0)?y.populateTransaction.buy(e,l.toBN(),0,N.d):void 0,b=l.gt(0)?(await y.callStatic.quoteBuyExactIn(e,l.toBN(),0)).synthAmount:W.GH,A=a.add(b),$=y.populateTransaction.unwrap(e,A.toBN(),Number(E.formatUnits(A.toBN().mul(98).div(100).toString(),12).toString()).toFixed()),[I,q,P,U,B,_]=await Promise.all([s,c,u,p,w,$]),H=[q,P,U,B,_].filter(L._);v&&H.unshift(v);const O=await j.getAddress(),F=await(0,C.dI)(f,H,"useWithdrawBase",O),M=(0,m.F)({gasLimit:F.gasLimit,gasPrices:I,gasSpeed:T}),Q=await j.sendTransaction({...F,...M});n({type:"pending",payload:{txnHash:Q.hash}}),await Q.wait(),n({type:"success"})}catch(t){throw n({type:"error",payload:{error:t}}),t}}});return{mutation:A,txnState:i,settle:()=>n({type:"settled"}),isLoading:A.isPending,exec:A.mutateAsync}};var _=e(13797),H=e(89536),O=e(45071),F=e(73635),M=e(64996),Q=e(52322);const G=({isDebtWithdrawal:t,amount:a,isOpen:e,onClose:n,onSubmit:l,state:c,symbol:u})=>{if(e)return c.step>1?(0,Q.jsx)($.s,{onClose:l,title:(t?"Debt":"Collateral")+" successfully Withdrawn",subline:(0,Q.jsxs)(Q.Fragment,{children:["Your ",(0,Q.jsx)("b",{children:t?"Debt":"Collateral"})," has been withdrawn, read more about it in the"," ",(0,Q.jsx)(s.r,{href:"https://docs.synthetix.io/v/synthetix-v3-user-documentation",target:"_blank",color:"cyan.500",children:"Synthetix V3 Documentation"})]}),alertText:(t?"Debt":"Collateral")+" successfully Withdrawn"}):(0,Q.jsxs)("div",{children:[(0,Q.jsxs)(r.x,{color:"gray.50",fontSize:"20px",fontWeight:700,children:[(0,Q.jsx)(A.R,{cursor:"pointer",onClick:n,mr:2}),"Manage ",t?"Debt":"Collateral"]}),(0,Q.jsx)(o.i,{my:4}),(0,Q.jsx)(d.P0,{step:1,title:"Withdraw",subtitle:(0,Q.jsxs)(r.x,{as:"div",children:[(0,Q.jsx)(O.$,{value:a}),"Â ",u," will be withdrawn"]}),status:{failed:1===c.step&&"error"===c.status,success:c.step>1,loading:1===c.step&&"pending"===c.status}}),(0,Q.jsx)(i.z,{isDisabled:"pending"===c.status,onClick:l,width:"100%",mt:"6","data-testid":"withdraw confirm button",children:(()=>{switch(!0){case"error"===c.status:return"Retry";case"pending"===c.status:return"Processing...";case c.step>1:return"Done";default:return"Execute Transaction"}})()})]})};function K({liquidityPosition:t,onClose:a,isOpen:e,isDebtWithdrawal:s=!1}){const[r,o]=(0,l.useState)({step:1,status:"idle"}),i=(0,H.UO)(),d=(0,n.p)({isClosable:!0,duration:9e3}),{network:w}=(0,p.LN)(),y=(0,u.useQueryClient)(),{withdrawAmount:h,setWithdrawAmount:m}=(0,l.useContext)(_.n),{data:g}=(0,M.t)(i.collateralSymbol),{data:b}=(0,c.a)(),x=(0,j.o)(b),v=t?.accountId,{data:C}=(0,F.p)(),{data:f}=(0,T.jZ)(v,C?.address),{mutation:A}=S({amount:h,accountId:v,collateralTypeAddress:s?C?.address:t?.accountCollateral?.tokenAddress}),{mutation:$}=B({accountId:v,availableCollateral:t?.accountCollateral.availableCollateral||W.GH,snxUSDCollateral:f?.availableCollateral||W.GH,amountToWithdraw:h,accountCollateral:t?.accountCollateral,collateralSymbol:i.collateralSymbol}),N=(0,l.useCallback)((async()=>{try{1===r.step?(o({step:1,status:"pending"}),(0,D.Yz)(w?.id,w?.preset)?await $.mutateAsync():await A.mutateAsync(),o({step:2,status:"success"}),y.invalidateQueries({queryKey:[`${w?.id}-${w?.preset}`,"LiquidityPosition",{accountId:v}]}),y.invalidateQueries({queryKey:[`${w?.id}-${w?.preset}`,"AccountSpecificCollateral",{accountId:v}]}),y.invalidateQueries({queryKey:[`${w?.id}-${w?.preset}`,"LiquidityPositions",{accountId:v}]}),y.invalidateQueries({queryKey:[`${w?.id}-${w?.preset}`,"AccountCollateralUnlockDate",{accountId:v}]}),y.invalidateQueries({queryKey:[`${w?.id}-${w?.preset}`,"TokenBalance"]}),m(W.GH)):a()}catch(t){o((t=>({...t,status:"error"})));const a=x(t);throw a&&console.error(new Error(a.name),a),d.closeAll(),d({title:"Withdraw failed",description:a?(0,Q.jsx)(k.M,{contractError:a}):"Please try again.",status:"error",variant:"left-accent"}),Error("Withdraw failed",{cause:t})}}),[v,x,w?.id,w?.preset,a,y,m,d,r.step,$,A]);return(0,Q.jsx)(G,{amount:h,isOpen:e,onClose:a,symbol:s?C?.symbol:g?.symbol,state:r,onSubmit:N,isDebtWithdrawal:s})}const z=K}}]);
//# sourceMappingURL=7665.d6c192b1.js.map