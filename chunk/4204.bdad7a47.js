"use strict";(globalThis.webpackChunk_snx_v3_liquidity=globalThis.webpackChunk_snx_v3_liquidity||[]).push([[4204],{99581:(e,t,a)=>{a.d(t,{M:()=>d});var r=a(2784),o=a(84626),n=a(87651),s=a(59176),i=a(65068),l=a(52322);const c="true"===window?.localStorage?.CONTRACT_ERROR_OPEN;function d({contractError:e}){const[t,a]=r.useState(c);return(0,l.jsxs)(l.Fragment,{children:[t?null:(0,l.jsx)(o.z,{variant:"link",onClick:()=>a(!0),color:"inherit",fontWeight:"normal",fontStyle:"italic",children:"details..."}),(0,l.jsxs)(n.U,{in:t,animateOpacity:!0,children:[(0,l.jsx)(s.x,{fontStyle:"italic",fontSize:"0.8em",children:e.name}),(0,l.jsx)(s.x,{whiteSpace:"pre",fontSize:"0.8em",fontStyle:"italic",pl:"0.5em",children:Object.entries(e.args).map((([e,t])=>`${e}: ${t instanceof Date?(0,i.Z)(t,"yyyy-MM-dd HH:mm:ss"):t}`)).join("\n")})]})]})}},14204:(e,t,a)=>{a.r(t),a.d(t,{DepositModal:()=>ge,DepositModalUi:()=>me,default:()=>fe});var r=a(66901),o=a(26468),n=a(19433),s=a(54326),i=a(2338),l=a(97217),c=a(59176),d=a(84626),p=a(70065),u=a(2784),h=a(19299),m=a(45071),g=a(49494),f=a(73557),x=a(16060),y=a(42383),w=a(76885),v=a(95042),b=a(55576),A=a(50986),j=a(28145);const C=["function deposit() payable","function withdraw(uint256 wad)"];var T=a(25042),$=a(79929),S=a(40109),E=a(17716),k=a(10528),I=a(99),P=a(35834),O=a(95772),D=a(860),q=a(37330),L=a(51686),N=a(95522);var M=a(89536),_=a(9875),z=a(97386);const R="SET_REQUIRE_APPROVAL",B="SET_WRAP_AMOUNT",H="SET_INFINITE_APPROVAL",F="RETRY",W="RUN",U="RESET",Q="idle",Y="wrap",K="approve",X="deposit",Z="failed",G="success",V={[K]:K,[Y]:Y,[X]:X},J="wrapEth",ee="approveWETH",te="executeDeposit",ae={wrapAmount:(0,$.wei)(0),error:null,requireApproval:!1,infiniteApproval:!1},re=(0,_.C)({id:"DepositMachine",initial:Q,predictableActionArguments:!0,context:ae,on:{[W]:{target:X,actions:(0,z.f0)({wrapAmount:e=>ae.wrapAmount,error:e=>ae.error,requireApproval:e=>ae.requireApproval,infiniteApproval:e=>ae.infiniteApproval})},[R]:{actions:(0,z.f0)({requireApproval:(e,t)=>t.requireApproval})},[B]:{actions:(0,z.f0)({wrapAmount:(e,t)=>t.wrapAmount})},[H]:{actions:(0,z.f0)({infiniteApproval:(e,t)=>t.infiniteApproval})}},states:{[Q]:{on:{[W]:[{target:Y,cond:e=>e.wrapAmount.gt(0)},{target:K,cond:e=>e.requireApproval},{target:X}]}},[Y]:{invoke:{src:J,onError:{target:Z,actions:(0,z.f0)({error:(e,t)=>({error:t.data,step:V.wrap})})},onDone:[{target:K,cond:e=>e.requireApproval},{target:X}]}},[K]:{invoke:{src:ee,onDone:{target:X},onError:{target:Z,actions:(0,z.f0)({error:(e,t)=>({error:t.data,step:V.approve})})}}},[X]:{invoke:{src:te,onDone:{target:G},onError:{target:Z,actions:(0,z.f0)({error:(e,t)=>({error:t.data,step:V.deposit})})}}},[Z]:{on:{[F]:[{target:K,cond:e=>e.error?.step===V.approve,actions:(0,z.f0)({error:e=>null})},{target:Y,cond:e=>e.error?.step===V.wrap,actions:(0,z.f0)({error:e=>null})},{target:X,cond:e=>e.error?.step===V.deposit,actions:(0,z.f0)({error:e=>null})}]}},[G]:{}}});var oe=a(97737),ne=a(97721),se=a(99581),ie=a(18914),le=a(77528),ce=a(81666),de=a(96596),pe=a(11838),ue=a(34367);var he=a(52322);const me=({collateralChange:e,isOpen:t,onClose:a,collateralType:p,setInfiniteApproval:u,onSubmit:h,state:g,availableCollateral:f,poolName:x})=>{const y=g.context.wrapAmount,w=g.context.infiniteApproval,v=g.context.requireApproval,b=g.context.error,A=g.matches(K)||g.matches(X)||g.matches(Y),j="WETH"===p?.symbol,C={wrap:j?1:0,approve:j?2:1,deposit:j?3:2};return(0,he.jsxs)(r.u_,{size:"lg",isOpen:t,onClose:a,closeOnOverlayClick:!1,children:[(0,he.jsx)(o.Z,{}),(0,he.jsxs)(n.h,{bg:"black",color:"white","data-cy":"deposit-modal",children:[(0,he.jsx)(s.x,{children:"Complete this action"}),(0,he.jsx)(i.o,{}),(0,he.jsxs)(l.f,{children:[(0,he.jsx)(c.x,{mb:"2",children:"Please execute the following transactions:"}),j?(0,he.jsx)(T.P0,{step:C.wrap,title:"Wrap",subtitle:y.eq(0)?(0,he.jsxs)(c.x,{as:"div",children:[(0,he.jsx)(m.$,{value:e,suffix:` ${p?.symbol}`})," from balance will be used."]}):(0,he.jsxs)(c.x,{as:"div",children:["You must wrap additional ",(0,he.jsx)(m.$,{value:y,suffix:" ETH"})," before depositing."]}),status:{failed:b?.step===Y,disabled:"WETH"!==p?.symbol,success:y.eq(0)||g.matches(G),loading:g.matches(Y)&&!b}}):null,(0,he.jsx)(T.P0,{step:C.approve,title:`Approve ${p?.symbol} transfer`,status:{failed:b?.step===K,success:!v||g.matches(G),loading:g.matches(K)&&!b},checkboxLabel:`Approve unlimited ${p?.symbol} transfers to Synthetix.`,checkboxProps:{isChecked:w,onChange:e=>u(e.target.checked)}}),(0,he.jsx)(T.P0,{step:C.deposit,title:`Delegate ${p?.symbol}`,subtitle:(0,he.jsx)(he.Fragment,{children:g.matches(G)?(0,he.jsxs)(c.x,{children:[(0,he.jsx)(m.$,{value:e,suffix:` ${p?.symbol}`})," ","delegated to ",x,"."]}):(0,he.jsx)(he.Fragment,{children:f&&f.gt((0,$.wei)(0))?(0,he.jsx)(he.Fragment,{children:f.gte(e)?(0,he.jsxs)(c.x,{children:["This will delegate"," ",(0,he.jsx)(m.$,{value:e,suffix:` ${p?.symbol}`})," ","to ",x,"."]}):(0,he.jsxs)(he.Fragment,{children:[(0,he.jsxs)(c.x,{children:["This will delegate"," ",(0,he.jsx)(m.$,{value:f,suffix:` ${p?.symbol}`})," ","to ",x,"."]}),(0,he.jsxs)(c.x,{children:["An additional"," ",(0,he.jsx)(m.$,{value:e.sub(f),suffix:` ${p?.symbol}`})," ","will be deposited and delegated from your wallet."]})]})}):(0,he.jsxs)(c.x,{children:["This will deposit and delegate"," ",(0,he.jsx)(m.$,{value:e,suffix:` ${p?.symbol}`})," to"," ",x,"."]})})}),status:{failed:b?.step===X,disabled:g.matches(G)&&v,success:g.matches(G),loading:g.matches(X)&&!b}}),(0,he.jsx)(d.z,{isDisabled:A,onClick:h,width:"100%",my:"4","data-cy":"deposit-confirm-button",children:(()=>{switch(!0){case Boolean(b):return"Retry";case A:return"Processing...";case g.matches(G):return"Done";default:return"Start"}})()})]})]})]})},ge=({onClose:e,isOpen:t,collateralChange:a,currentCollateral:r,availableCollateral:o})=>{const n=(0,f.s0)(),{collateralSymbol:s,poolId:i,accountId:l}=(0,M.UO)(),c=(0,j.useQueryClient)(),{network:d}=(0,w.LN)(),{data:m}=(0,S.a)(),{data:T}=(0,ce.b)(),{data:_}=(0,ue.X)(),{data:z}=(0,h.t)(s),Q=(0,le.Yz)(d?.id,d?.preset)?_?.USDC:z?.tokenAddress,Y=a.sub(o),{approve:K,requireApproval:Z}=(0,y.y)({contractAddress:Q,amount:Y.gt(0)?(0,le.Yz)(d?.id,d?.preset)?g.vz(Y.toString(),6):Y.toBN():0,spender:(0,le.Yz)(d?.id,d?.preset)?T?.address:m?.address}),V=(0,p.p)({isClosable:!0,duration:9e3}),ae=(0,u.useMemo)((()=>`${Math.floor(1e10*Math.random())}`),[]),{exec:ge,wethBalance:fe}=(()=>{const e=(0,w.mx)(),{data:t}=(0,h.t)("WETH"),{data:a,refetch:r}=(0,v.G)(),{data:o,refetch:n}=(0,b.mM)(t?.tokenAddress),{mutateAsync:s,isPending:i}=(0,j.useMutation)({mutationFn:async a=>{if(!t||!e)return;const r=new A.CH(t?.tokenAddress,C,e),o=await r.deposit({value:a.toBN()});await o.wait()}});return{exec:(0,u.useCallback)((async e=>{a&&(a.lt(e)||(await s(e),r(),n()))}),[a,s,r,n]),isLoading:i,wethBalance:o,ethBalance:a}})(),xe="WETH"===z?.symbol&&a.gt(fe||0)?a.sub(fe||0):(0,$.wei)(0),{data:ye}=(0,ie.AI)(i),{exec:we}=(({accountId:e,newAccountId:t,poolId:a,collateralTypeAddress:r,collateralChange:o,currentCollateral:n,availableCollateral:s})=>{const[i,l]=(0,u.useReducer)(E.I,E.E),{data:c}=(0,S.a)(),{data:d}=(0,L.L)(),{gasSpeed:p}=(0,O.jU)(),{network:h}=(0,w.LN)(),m=(0,w.mx)(),g=(0,w.yL)(),f=(0,j.useMutation)({mutationFn:async()=>{if(h&&g&&m&&c&&a&&r&&s&&d&&!o.eq(0))try{l({type:"prompting"});const i=await m.getAddress(),u=e??t,f=e?void 0:c.populateTransaction["createAccount(uint128)"](k.O$.from(u)),x=s.gte(o)?void 0:c.populateTransaction.deposit(k.O$.from(u),r,o.sub(s).toBN()),y=c.populateTransaction.delegateCollateral(k.O$.from(u),k.O$.from(a),r,n.add(o).toBN(),(0,$.wei)(1).toBN()),w=Promise.all([f,x,y].filter(q._)),v=(0,N.$)(d,h?.isTestnet).then((e=>(0,N.x)(i,d,e))),[b,A,j]=await Promise.all([w,(0,P.o)({provider:g}),v]),C=j.concat(b),T=await(0,D.dI)(h,C,"useDeposit",c.interface),S=(0,I.F)({gasLimit:T.gasLimit,gasPrices:A,gasSpeed:p}),E=await m.sendTransaction({...T,...S});l({type:"pending",payload:{txnHash:E.hash}}),await E.wait(),l({type:"success"})}catch(e){throw l({type:"error",payload:{error:e}}),e}}});return{mutation:f,txnState:i,settle:()=>l({type:"settled"}),isLoading:f.isPending,exec:f.mutateAsync}})({accountId:l,newAccountId:ae,poolId:i,collateralTypeAddress:Q,collateralChange:a,currentCollateral:r,availableCollateral:o||(0,$.wei)(0)}),{exec:ve}=(({accountId:e,newAccountId:t,poolId:a,collateralTypeAddress:r,collateralChange:o,currentCollateral:n,availableCollateral:s})=>{const[i,l]=(0,u.useReducer)(E.I,E.E),{data:c}=(0,S.a)(),{data:d}=(0,ce.b)(),{data:p}=(0,pe.Y)(),{data:h}=(0,ue.X)(),{gasSpeed:m}=(0,O.jU)(),{network:g}=(0,w.LN)(),f=(0,w.mx)(),x=(0,w.yL)(),v=(0,j.useMutation)({mutationFn:async()=>{if(g&&x&&f&&c&&d&&a&&r&&s&&h?.sUSD&&!o.eq(0))try{l({type:"prompting"});const r=e??t,i=e?void 0:c.populateTransaction["createAccount(uint128)"](k.O$.from(r)),u=o.sub(s),w=u.gt(0)?(0,de.vz)(u.toString(),6):k.O$.from(0),v=u.gt(0)?(0,de.vz)(u.toString(),18):k.O$.from(0),b=h?.sUSD,j=w.gt(0)?d.populateTransaction.wrap(le.Ds,w,v):void 0,C=new A.CH(b,y.P,f),T=v.gt(0)?C.populateTransaction.approve(c.address,v):void 0,S=v.gt(0)?c.populateTransaction.deposit(k.O$.from(r),b,v):void 0,E=c.populateTransaction.delegateCollateral(k.O$.from(r),k.O$.from(a),b,n.toBN().add((0,de.vz)(o.toString(),18)).toString(),(0,$.wei)(1).toBN()),O=Promise.all([j,T,i,S,E].filter(q._)),[L,N]=await Promise.all([O,(0,P.o)({provider:x})]);p&&L.unshift(p);const M=await(0,D.dI)(g,L,"useDepositBaseAndromeda",c.interface),_=(0,I.F)({gasLimit:M.gasLimit,gasPrices:N,gasSpeed:m}),z=await f.sendTransaction({...M,..._});l({type:"pending",payload:{txnHash:z.hash}}),await z.wait(),l({type:"success"})}catch(e){throw l({type:"error",payload:{error:e}}),e}}});return{mutation:v,txnState:i,settle:()=>l({type:"settled"}),isLoading:v.isPending,exec:v.mutateAsync}})({accountId:l,newAccountId:ae,poolId:i,collateralTypeAddress:Q,collateralChange:a,currentCollateral:r,availableCollateral:o||(0,$.wei)(0)}),be=(0,ne.o)(m),[Ae,je]=(0,oe.e)(re,{services:{[J]:async()=>{try{await ge(Ae.context.wrapAmount)}catch(e){const t=be(e);throw t&&console.error(new Error(t.name),t),V.closeAll(),V({title:"Wrapping ETH failed",description:t?(0,he.jsx)(se.M,{contractError:t}):"Please try again.",status:"error"}),Error("Wrapping failed",{cause:e})}},[ee]:async()=>{try{V({title:"Approve collateral for transfer",description:l?"The next transaction will delegate this collateral.":"The next transaction will create your account and and delegate this collateral",status:"info"}),await K(Boolean(Ae.context.infiniteApproval))}catch(e){const t=be(e);throw t&&console.error(new Error(t.name),t),V.closeAll(),V({title:"Approval failed",description:t?(0,he.jsx)(se.M,{contractError:t}):"Please try again.",status:"error"}),Error("Approve failed",{cause:e})}},[te]:async()=>{try{V.closeAll(),V({title:Boolean(l)?"Delegating your collateral":"Creating your account and depositing collateral",description:""}),(0,le.Yz)(d?.id,d?.preset)?await ve():await we(),await Promise.all([c.invalidateQueries({queryKey:[`${d?.id}-${d?.preset}`,"EthBalance"]}),c.invalidateQueries({queryKey:[`${d?.id}-${d?.preset}`,"LiquidityPosition"]}),"SNX"===z?.symbol?c.invalidateQueries({queryKey:[`${d?.id}-${d?.preset}`,"TransferableSynthetix"]}):Promise.resolve(),c.invalidateQueries({queryKey:[`${d?.id}-${d?.preset}`,"Allowance"]}),c.invalidateQueries({queryKey:[`${d?.id}-${d?.preset}`,"LiquidityPositions"]}),l?Promise.resolve():c.invalidateQueries({queryKey:[`${d?.id}-${d?.preset}`,"Accounts"]})]),V.closeAll(),V({title:"Success",description:"Your delegated collateral amount has been updated.",status:"success",duration:5e3})}catch(e){const t=be(e);throw t&&console.error(new Error(t.name),t),V({title:"Could not complete delegating collateral",description:t?(0,he.jsx)(se.M,{contractError:t}):"Please try again.",status:"error"}),Error("Delegate collateral failed",{cause:e})}}}}),Ce=xe.toString(),Te=Ae.matches(G)||Ae.matches(X);(0,u.useEffect)((()=>{Te||je(B,{wrapAmount:(0,$.wei)(Ce)})}),[Ce,je,Te]),(0,u.useEffect)((()=>{je(R,{requireApproval:Z})}),[Z,je]);const $e=(0,f.TH)(),Se=(0,u.useCallback)((()=>{Ae.matches(G)&&i&&z?.symbol&&(je(U),e(),n({pathname:(0,x.Gn)("/positions/:collateralType/:poolId",{collateralType:z.symbol,poolId:i}),search:$e.search})),je(U),e()}),[$e.search,je,e,Ae,i,z?.symbol,n]),Ee=(0,u.useCallback)((async()=>{Ae.matches(G)?Se():Ae.context.error?je(F):je(W)}),[Se,je,Ae]);return(0,he.jsx)(me,{collateralChange:a,isOpen:t,onClose:e,collateralType:z,state:Ae,setInfiniteApproval:e=>{je(H,{infiniteApproval:e})},onSubmit:Ee,poolName:ye?.name||"",availableCollateral:o||(0,$.wei)(0)})},fe=ge},25042:(e,t,a)=>{a.d(t,{nQ:()=>l,Tw:()=>c,P0:()=>f});var r=a(38035),o=a(81540),n=a(28535),s=a(21112),i=a(52322);const l=(0,s.I)({viewBox:"0 0 14 14",path:(0,i.jsx)("g",{fill:"currentColor",children:(0,i.jsx)("polygon",{points:"5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"})})}),c=(0,s.I)({d:"M.439,21.44a1.5,1.5,0,0,0,2.122,2.121L11.823,14.3a.25.25,0,0,1,.354,0l9.262,9.263a1.5,1.5,0,1,0,2.122-2.121L14.3,12.177a.25.25,0,0,1,0-.354l9.263-9.262A1.5,1.5,0,0,0,21.439.44L12.177,9.7a.25.25,0,0,1-.354,0L2.561.44A1.5,1.5,0,0,0,.439,2.561L9.7,11.823a.25.25,0,0,1,0,.354Z"});function d({status:e,children:t}){switch(!0){case e.failed:return(0,i.jsx)(c,{color:"white"});case e.success:return(0,i.jsx)(l,{color:"white"});case e.loading:return(0,i.jsx)(o.$,{color:"white",width:6,height:6});case e.disabled:default:return(0,i.jsx)(n.xu,{__css:{display:"inline",fontWeight:"medium",textAlign:"center",fontSize:"md"},children:t})}}function p(e){switch(!0){case e.failed:return"red.700";case e.disabled:case e.loading:return"gray.700";case e.success:return"green.700";default:return"gray.700"}}function u({status:e,children:t}){return(0,i.jsx)(r.k,{width:10,height:10,minWidth:10,minHeight:10,justifyContent:"center",alignItems:"center",bg:p(e),rounded:"full",transitionProperty:"background",transitionDuration:"normal",children:(0,i.jsx)(d,{status:e,children:t})})}var h=a(78876),m=a(59176);function g({children:e,...t}){return(0,i.jsx)(r.k,{mt:"0.5",children:(0,i.jsx)(h.X,{size:"sm",...t,children:(0,i.jsx)(n.xu,{fontSize:"xs",opacity:"0.66",children:e})})})}function f({step:e,title:t,subtitle:a,checkboxLabel:o,checkboxProps:n,status:s,children:l}){return(0,i.jsxs)(r.k,{position:"relative",alignItems:"center",gap:4,rounded:"lg",mt:"4",p:"4",border:"2px solid",transitionProperty:"border-color",transitionDuration:"normal",borderColor:p(s),children:[(0,i.jsx)(u,{status:s,children:e}),(0,i.jsxs)(r.k,{direction:"column",children:[(0,i.jsx)(m.x,{"data-cy":`multistep-${e}`,children:t}),a?(0,i.jsx)(m.x,{as:"div",fontSize:"xs",opacity:"0.66",children:a}):null,o?(0,i.jsx)(g,{...n,children:o}):null,l]})]})}},97721:(e,t,a)=>{a.d(t,{o:()=>c});a(5875),a(50509),a(38728),a(64810),a(43419),a(32825),a(16093),a(77829),a(60253),a(49225),a(79941),a(57265),a(25888),a(15840),a(37610),a(13351);var r=a(79155),o=a(50986),n=a(10528),s=a(49494),i=a(2784),l=a(860);function c(e){return(0,i.useCallback)((t=>{if(e)try{const a=t?.error?.data?.data||t?.error?.error?.data;if(!a)return void console.error({error:t});const i=e.interface.format(r.pc.full),c=new o.CH(e.address,Array.from(new Set(i.concat(l.IN).concat(["error CannotSelfApprove(address addr)","error InvalidTransferRecipient(address addr)","error InvalidOwner(address addr)","error TokenDoesNotExist(uint256 id)","error TokenAlreadyMinted(uint256 id)"]))),e.signer||e.provider).interface.parseError(a),d=Object.fromEntries(Object.entries(c.args).filter((([e])=>`${parseInt(e)}`!==e)).map((([e,t])=>{if(t instanceof n.O$){const a=parseFloat(s.dF(t.toString()));return a>.001?[e,a]:t.toNumber()>new Date(2e3,1,1).getTime()/1e3&&t.toNumber()<new Date(2100,1,1).getTime()/1e3?[e,new Date(1e3*t.toNumber())]:[e,parseFloat(t.toString())]}return[e,t]})));return{data:a,name:c.name,signature:c.signature,args:d}}catch(e){return void console.error(e)}}),[e])}}}]);
//# sourceMappingURL=4204.bdad7a47.js.map