"use strict";(globalThis.webpackChunk_snx_v3_liquidity=globalThis.webpackChunk_snx_v3_liquidity||[]).push([[6275],{26275:(e,t,a)=>{a.r(t),a.d(t,{RepayModal:()=>te,RepayModalUi:()=>ee,default:()=>ae});var r=a(66901),s=a(26468),o=a(19433),i=a(54326),n=a(2338),l=a(97217),c=a(59176),p=a(84626),d=a(88115),u=a(45071),y=a(25042),h=a(2784),v=a(99581),f=a(40109),A=a(99),g=a(79634),b=a(76885),m=a(17716),x=a(10528),C=a(35834),w=a(95772),S=a(19582),R=a(37330),E=a(86848),k=a(51686),q=a(95522);var I=a(89536),j=a(13797),P=a(19299),T=a(97721),U=a(85649),L=a(97096),O=a(97737),_=a(9875),D=a(97386);const $="SET_REQUIRE_APPROVAL",N="SET_INFINITE_APPROVAL",B="RETRY",M="RUN",Q="RESET",F="idle",K="approve",z="repay",V="failed",Y="success",H={[K]:K,[z]:z},Z="approveSUSD",G="executeRepay",J={error:null,requireApproval:!1,infiniteApproval:!1},W=(0,_.C)({id:"RepayMachine",initial:F,predictableActionArguments:!0,context:J,on:{[M]:{target:z,actions:(0,D.f0)({error:e=>J.error,requireApproval:e=>J.requireApproval,infiniteApproval:e=>J.infiniteApproval})},[$]:{actions:(0,D.f0)({requireApproval:(e,t)=>t.requireApproval})},[N]:{actions:(0,D.f0)({infiniteApproval:(e,t)=>t.infiniteApproval})}},states:{[F]:{on:{[M]:[{target:K,cond:e=>e.requireApproval},{target:z}]}},[K]:{invoke:{src:Z,onDone:{target:z},onError:{target:V,actions:(0,D.f0)({error:(e,t)=>({error:t.data,step:H.approve})})}}},[z]:{invoke:{src:G,onDone:{target:Y},onError:{target:V,actions:(0,D.f0)({error:(e,t)=>({error:t.data,step:H.repay})})}}},[V]:{on:{[B]:[{target:K,cond:e=>e.error?.step===H.approve,actions:(0,D.f0)({error:e=>null})},{target:z,cond:e=>e.error?.step===H.repay,actions:(0,D.f0)({error:e=>null})}]}},[Y]:{}}});var X=a(52322);const ee=({onClose:e,isOpen:t,debtChange:a,state:d,onSubmit:h,setInfiniteApproval:v})=>{const f=d.matches(K)||d.matches(z),{infiniteApproval:A,requireApproval:g,error:b}=d.context;return(0,X.jsxs)(r.u_,{size:"lg",isOpen:t,onClose:e,closeOnOverlayClick:!1,children:[(0,X.jsx)(s.Z,{}),(0,X.jsxs)(o.h,{bg:"black",color:"white","data-testid":"repay modal",children:[(0,X.jsx)(i.x,{children:"Complete this action"}),(0,X.jsx)(n.o,{}),(0,X.jsxs)(l.f,{children:[(0,X.jsx)(y.P0,{step:1,title:"Approve sUSD transfer",status:{failed:b?.step===K,success:!g||d.matches(Y),loading:d.matches(K)&&!b},checkboxLabel:"Approve unlimited sUSD transfers to Synthetix.",checkboxProps:{isChecked:A,onChange:e=>v(e.target.checked)}}),(0,X.jsx)(y.P0,{step:2,title:"Repay",subtitle:(0,X.jsxs)(c.x,{children:["Repay ",(0,X.jsx)(u.$,{value:a.abs(),suffix:" sUSD"})]}),status:{failed:b?.step===z,success:d.matches(Y),loading:d.matches(z)&&!b}}),(0,X.jsx)(p.z,{isDisabled:f,onClick:h,width:"100%",my:"4","data-testid":"repay confirm button",children:(()=>{switch(!0){case Boolean(b):return"Retry";case f:return"Processing...";case d.matches(Y):return"Done";default:return"Start"}})()})]})]})]})},te=({onClose:e,isOpen:t,availableCollateral:a})=>{const{debtChange:r}=(0,h.useContext)(j.n),s=(0,I.UO)(),o=(0,b.LN)(),i=(0,g.useQueryClient)(),{data:n}=(0,S.a)(),{data:l}=(0,P.t)(s.collateralSymbol),{data:c}=(0,L.m)(n?.address),{exec:p,settle:u}=(({accountId:e,poolId:t,collateralTypeAddress:a,debtChange:r,balance:s,availableUSDCollateral:o})=>{const[i,n]=(0,h.useReducer)(m.I,m.E),{data:l}=(0,f.a)(),{data:c}=(0,S.a)(),{data:p}=(0,k.L)(),d=(0,b.mx)(),u=(0,b.LN)(),{gasSpeed:y}=(0,w.jU)(),v=(0,b.yL)(),I=(0,g.useMutation)({mutationFn:async()=>{if(!d)return;if(!(l&&t&&e&&a&&c&&p))return;if(!s)return;if(!o)return;if(r.eq(0))return;const i=r.abs(),h=i.sub(o);try{n({type:"prompting"});const r=h.lte(0)?void 0:l.populateTransaction.deposit(x.O$.from(e),c.address,h.toBN()),s=l.populateTransaction.burnUsd(x.O$.from(e),x.O$.from(t),a,i.toBN()),o=Promise.all([r,s].filter(R._)),f=await d.getAddress(),g=(0,q.$)(p,u.isTestnet).then((e=>(0,q.x)(f,p,e))),[b,m,w]=await Promise.all([o,(0,C.o)({provider:v}),g]),S=w.concat(b),k=await(0,E.dI)(u,S,"useRepay"),I=(0,A.F)({gasLimit:k.gasLimit,gasPrices:m,gasSpeed:y}),j=await d.sendTransaction({...k,...I});n({type:"pending",payload:{txnHash:j.hash}}),await j.wait(),n({type:"success"})}catch(e){throw n({type:"error",payload:{error:e}}),e}}});return{mutation:I,txnState:i,settle:()=>n({type:"settled"}),isLoading:I.isLoading,exec:I.mutateAsync}})({accountId:s.accountId,poolId:s.poolId,collateralTypeAddress:l?.tokenAddress,debtChange:r,availableUSDCollateral:a,balance:c}),y=(0,d.p)({isClosable:!0,duration:9e3}),{data:_}=(0,f.a)(),D=(0,T.o)(_),F=r.abs().sub(a||0),{approve:K,requireApproval:z}=(0,U.y)({contractAddress:n?.address,amount:F.toBN(),spender:_?.address}),[V,H]=(0,O.e)(W,{services:{[Z]:async()=>{try{y({title:"Approve sUSD for transfer",description:"The next transaction will repay your debt.",status:"info"}),await K(Boolean(V.context.infiniteApproval))}catch(e){const t=D(e);throw t&&console.error(new Error(t.name),t),y.closeAll(),y({title:"Approval failed",description:t?(0,X.jsx)(v.M,{contractError:t}):"Please try again.",status:"error"}),Error("Approve failed",{cause:e})}},[G]:async()=>{try{y.closeAll(),y({title:"Repaying..."}),await p(),await Promise.all([i.invalidateQueries({queryKey:[`${o.id}-${o.preset}`,"TokenBalance"]}),i.invalidateQueries({queryKey:[`${o.id}-${o.preset}`,"Allowance"]}),i.invalidateQueries({queryKey:[`${o.id}-${o.preset}`,"LiquidityPosition"]})]),y.closeAll(),y({title:"Success",description:"Your debt has been repaid.",status:"success",duration:5e3})}catch(e){const t=D(e);throw t&&console.error(new Error(t.name),t),y({title:"Could not complete repaying",description:t?(0,X.jsx)(v.M,{contractError:t}):"Please try again.",status:"error"}),Error("Repay failed",{cause:e})}}}}),J=F.gt(0);(0,h.useEffect)((()=>{H($,{requireApproval:z&&J})}),[J,z,H]);const te=(0,h.useCallback)((async()=>{if(V.matches(Y))return H(Q),void e();V.context.error?H(B):H(M)}),[e,H,V]);return s.poolId&&s.accountId&&l?(0,X.jsx)(ee,{state:V,onSubmit:te,debtChange:r,setInfiniteApproval:e=>{H(N,{infiniteApproval:e})},onClose:()=>{u(),e()},isOpen:t}):null},ae=te}}]);
//# sourceMappingURL=6275.6b577a58.js.map