"use strict";(globalThis.webpackChunk_snx_v3_liquidity=globalThis.webpackChunk_snx_v3_liquidity||[]).push([[6275],{26275:(e,t,a)=>{a.r(t),a.d(t,{RepayModal:()=>se,RepayModalUi:()=>oe,default:()=>ie});var r=a(66901),o=a(26468),s=a(19433),i=a(54326),n=a(2338),l=a(97217),c=a(59176),p=a(84626),d=a(70065),u=a(45071),y=a(25042),h=a(2784),v=a(99581),f=a(40109),g=a(99),A=a(28145),b=a(76885),m=a(17716),x=a(10528),w=a(35834),C=a(95772),S=a(63478),k=a(37330),I=a(860),E=a(51686),R=a(95522);var P=a(89536),q=a(13797),T=a(19299),j=a(97721),U=a(85649),D=a(55576),O=a(97737),_=a(9875),L=a(97386);const $="SET_REQUIRE_APPROVAL",N="SET_INFINITE_APPROVAL",z="RETRY",M="RUN",B="RESET",Y="idle",Q="approve",F="repay",K="failed",V="success",H={[Q]:Q,[F]:F},Z="approveSUSD",G="executeRepay",J={error:null,requireApproval:!1,infiniteApproval:!1},W=(0,_.C)({id:"RepayMachine",initial:Y,predictableActionArguments:!0,context:J,on:{[M]:{target:F,actions:(0,L.f0)({error:e=>J.error,requireApproval:e=>J.requireApproval,infiniteApproval:e=>J.infiniteApproval})},[$]:{actions:(0,L.f0)({requireApproval:(e,t)=>t.requireApproval})},[N]:{actions:(0,L.f0)({infiniteApproval:(e,t)=>t.infiniteApproval})}},states:{[Y]:{on:{[M]:[{target:Q,cond:e=>e.requireApproval},{target:F}]}},[Q]:{invoke:{src:Z,onDone:{target:F},onError:{target:K,actions:(0,L.f0)({error:(e,t)=>({error:t.data,step:H.approve})})}}},[F]:{invoke:{src:G,onDone:{target:V},onError:{target:K,actions:(0,L.f0)({error:(e,t)=>({error:t.data,step:H.repay})})}}},[K]:{on:{[z]:[{target:Q,cond:e=>e.error?.step===H.approve,actions:(0,L.f0)({error:e=>null})},{target:F,cond:e=>e.error?.step===H.repay,actions:(0,L.f0)({error:e=>null})}]}},[V]:{}}});var X=a(9267),ee=a(77528),te=a(96596),ae=a(81666),re=a(52322);const oe=({onClose:e,isOpen:t,debtChange:a,state:d,onSubmit:h,setInfiniteApproval:v})=>{const f=d.matches(Q)||d.matches(F),{infiniteApproval:g,requireApproval:A,error:b}=d.context;return(0,re.jsxs)(r.u_,{size:"lg",isOpen:t,onClose:e,closeOnOverlayClick:!1,children:[(0,re.jsx)(o.Z,{}),(0,re.jsxs)(s.h,{bg:"black",color:"white","data-testid":"repay modal",children:[(0,re.jsx)(i.x,{children:"Complete this action"}),(0,re.jsx)(n.o,{}),(0,re.jsxs)(l.f,{children:[(0,re.jsx)(y.P0,{step:1,title:"Approve sUSD transfer",status:{failed:b?.step===Q,success:!A||d.matches(V),loading:d.matches(Q)&&!b},checkboxLabel:"Approve unlimited sUSD transfers to Synthetix.",checkboxProps:{isChecked:g,onChange:e=>v(e.target.checked)}}),(0,re.jsx)(y.P0,{step:2,title:"Repay",subtitle:(0,re.jsxs)(c.x,{children:["Repay ",(0,re.jsx)(u.$,{value:a.abs(),suffix:" sUSD"})]}),status:{failed:b?.step===F,success:d.matches(V),loading:d.matches(F)&&!b}}),(0,re.jsx)(p.z,{isDisabled:f,onClick:h,width:"100%",my:"4","data-testid":"repay confirm button",children:(()=>{switch(!0){case Boolean(b):return"Retry";case f:return"Processing...";case d.matches(V):return"Done";default:return"Start"}})()})]})]})]})},se=({onClose:e,isOpen:t,availableCollateral:a})=>{const{debtChange:r}=(0,h.useContext)(q.n),o=(0,P.UO)(),{network:s}=(0,b.LN)(),i=(0,A.useQueryClient)(),{data:n}=(0,S.a)(),{data:l}=(0,T.t)(o.collateralSymbol),{data:c}=(0,D.mM)(n?.address),{exec:p,settle:u}=(({accountId:e,poolId:t,collateralTypeAddress:a,debtChange:r,balance:o,availableUSDCollateral:s})=>{const[i,n]=(0,h.useReducer)(m.I,m.E),{data:l}=(0,f.a)(),{data:c}=(0,S.a)(),{data:p}=(0,E.L)(),d=(0,b.mx)(),{network:u}=(0,b.LN)(),{gasSpeed:y}=(0,C.jU)(),v=(0,b.yL)(),P=(0,A.useMutation)({mutationFn:async()=>{if(!d||!u||!v)throw new Error("No signer or network");if(!(l&&t&&e&&a&&c&&p))return;if(!o)return;if(!s)return;if(r.eq(0))return;const i=r.abs(),h=i.sub(s);try{n({type:"prompting"});const r=h.lte(0)?void 0:l.populateTransaction.deposit(x.O$.from(e),c.address,h.toBN()),o=l.populateTransaction.burnUsd(x.O$.from(e),x.O$.from(t),a,i.toBN()),s=Promise.all([r,o].filter(k._)),f=await d.getAddress(),A=(0,R.$)(p,u.isTestnet).then((e=>(0,R.x)(f,p,e))),[b,m,C]=await Promise.all([s,(0,w.o)({provider:v}),A]),S=C.concat(b),E=await(0,I.dI)(u,S,"useRepay",l.interface),P=(0,g.F)({gasLimit:E.gasLimit,gasPrices:m,gasSpeed:y}),q=await d.sendTransaction({...E,...P});n({type:"pending",payload:{txnHash:q.hash}}),await q.wait(),n({type:"success"})}catch(e){throw n({type:"error",payload:{error:e}}),e}}});return{mutation:P,txnState:i,settle:()=>n({type:"settled"}),isLoading:P.isPending,exec:P.mutateAsync}})({accountId:o.accountId,poolId:o.poolId,collateralTypeAddress:l?.tokenAddress,debtChange:r,availableUSDCollateral:a,balance:c}),{exec:y,settle:_}=(0,X.P)({accountId:o.accountId,poolId:o.poolId,collateralTypeAddress:l?.tokenAddress,debtChange:r,availableUSDCollateral:a}),L=(0,d.p)({isClosable:!0,duration:9e3}),{data:Y}=(0,f.a)(),{data:Q}=(0,ae.b)(),F=(0,j.o)(Y),K=r.abs().sub(a||0),H=(0,ee.Yz)(s?.id,s?.preset)?(0,ee.sm)(s?.id):n?.address,{approve:J,requireApproval:se}=(0,U.y)({contractAddress:H,amount:(0,ee.Yz)(s?.id,s?.preset)?(0,te.vz)(K.toString(),6):K.toBN(),spender:(0,ee.Yz)(s?.id,s?.preset)?Q?.address:Y?.address}),[ie,ne]=(0,O.e)(W,{services:{[Z]:async()=>{try{L({title:"Approve sUSD for transfer",description:"The next transaction will repay your debt.",status:"info"}),await J(Boolean(ie.context.infiniteApproval))}catch(e){const t=F(e);throw t&&console.error(new Error(t.name),t),L.closeAll(),L({title:"Approval failed",description:t?(0,re.jsx)(v.M,{contractError:t}):"Please try again.",status:"error"}),Error("Approve failed",{cause:e})}},[G]:async()=>{try{L.closeAll(),L({title:"Repaying..."}),(0,ee.Yz)(s?.id,s?.preset)?await y():await p(),await Promise.all([i.invalidateQueries({queryKey:[`${s?.id}-${s?.preset}`,"TokenBalance"]}),i.invalidateQueries({queryKey:[`${s?.id}-${s?.preset}`,"Allowance"]}),i.invalidateQueries({queryKey:[`${s?.id}-${s?.preset}`,"LiquidityPosition"]})]),L.closeAll(),L({title:"Success",description:"Your debt has been repaid.",status:"success",duration:5e3})}catch(e){const t=F(e);throw t&&console.error(new Error(t.name),t),L({title:"Could not complete repaying",description:t?(0,re.jsx)(v.M,{contractError:t}):"Please try again.",status:"error"}),Error("Repay failed",{cause:e})}}}}),le=K.gt(0);(0,h.useEffect)((()=>{ne($,{requireApproval:se&&le})}),[le,se,ne]);const ce=(0,h.useCallback)((async()=>{if(ie.matches(V))return ne(B),void e();ie.context.error?ne(z):ne(M)}),[e,ne,ie]);return o.poolId&&o.accountId&&l?(0,re.jsx)(oe,{state:ie,onSubmit:ce,debtChange:r,setInfiniteApproval:e=>{ne(N,{infiniteApproval:e})},onClose:()=>{u(),_(),e()},isOpen:t}):null},ie=se}}]);
//# sourceMappingURL=6275.f8e4a4d1.js.map