"use strict";(globalThis.webpackChunk_snx_v3_liquidity=globalThis.webpackChunk_snx_v3_liquidity||[]).push([[2899],{2899:(e,t,a)=>{a.r(t),a.d(t,{RepayModal:()=>ie,RepayModalUi:()=>ne,default:()=>le});var r=a(66901),o=a(26468),s=a(19433),n=a(54326),i=a(2338),l=a(97217),p=a(59176),c=a(84626),d=a(70065),u=a(45071),y=a(25042),v=a(2784),g=a(99581),h=a(40109),f=a(99),m=a(28145),b=a(76885),A=a(17716),w=a(10528),x=a(35834),C=a(95772),S=a(63478),I=a(37330),T=a(860),k=a(51686),P=a(95522);var E=a(89536),R=a(13797),q=a(19299),U=a(97721),j=a(85649),L=a(55576),N=a(97737),O=a(9875),D=a(97386);const $="SET_REQUIRE_APPROVAL",_="SET_INFINITE_APPROVAL",B="RETRY",z="RUN",M="RESET",Y="idle",F="approve",H="repay",Q="failed",K="success",V={[F]:F,[H]:H},Z="approveSUSD",G="executeRepay",J={error:null,requireApproval:!1,infiniteApproval:!1},W=(0,O.C)({id:"RepayMachine",initial:Y,predictableActionArguments:!0,context:J,on:{[z]:{target:H,actions:(0,D.f0)({error:e=>J.error,requireApproval:e=>J.requireApproval,infiniteApproval:e=>J.infiniteApproval})},[$]:{actions:(0,D.f0)({requireApproval:(e,t)=>t.requireApproval})},[_]:{actions:(0,D.f0)({infiniteApproval:(e,t)=>t.infiniteApproval})}},states:{[Y]:{on:{[z]:[{target:F,cond:e=>e.requireApproval},{target:H}]}},[F]:{invoke:{src:Z,onDone:{target:H},onError:{target:Q,actions:(0,D.f0)({error:(e,t)=>({error:t.data,step:V.approve})})}}},[H]:{invoke:{src:G,onDone:{target:K},onError:{target:Q,actions:(0,D.f0)({error:(e,t)=>({error:t.data,step:V.repay})})}}},[Q]:{on:{[B]:[{target:F,cond:e=>e.error?.step===V.approve,actions:(0,D.f0)({error:e=>null})},{target:H,cond:e=>e.error?.step===V.repay,actions:(0,D.f0)({error:e=>null})}]}},[K]:{}}});var X=a(50986),ee=a(51906),te=a(81666),ae=a(77528),re=a(96596),oe=a(11838);var se=a(52322);const ne=({onClose:e,isOpen:t,debtChange:a,state:d,onSubmit:v,setInfiniteApproval:g})=>{const h=d.matches(F)||d.matches(H),{infiniteApproval:f,requireApproval:m,error:b}=d.context;return(0,se.jsxs)(r.u_,{size:"lg",isOpen:t,onClose:e,closeOnOverlayClick:!1,children:[(0,se.jsx)(o.Z,{}),(0,se.jsxs)(s.h,{bg:"black",color:"white","data-testid":"repay modal",children:[(0,se.jsx)(n.x,{children:"Complete this action"}),(0,se.jsx)(i.o,{}),(0,se.jsxs)(l.f,{children:[(0,se.jsx)(y.P0,{step:1,title:"Approve sUSD transfer",status:{failed:b?.step===F,success:!m||d.matches(K),loading:d.matches(F)&&!b},checkboxLabel:"Approve unlimited sUSD transfers to Synthetix.",checkboxProps:{isChecked:f,onChange:e=>g(e.target.checked)}}),(0,se.jsx)(y.P0,{step:2,title:"Repay",subtitle:(0,se.jsxs)(p.x,{children:["Repay ",(0,se.jsx)(u.$,{value:a.abs(),suffix:" sUSD"})]}),status:{failed:b?.step===H,success:d.matches(K),loading:d.matches(H)&&!b}}),(0,se.jsx)(c.z,{isDisabled:h,onClick:v,width:"100%",my:"4","data-testid":"repay confirm button",children:(()=>{switch(!0){case Boolean(b):return"Retry";case h:return"Processing...";case d.matches(K):return"Done";default:return"Start"}})()})]})]})]})},ie=({onClose:e,isOpen:t,availableCollateral:a})=>{const{debtChange:r}=(0,v.useContext)(R.n),o=(0,E.UO)(),{network:s}=(0,b.LN)(),n=(0,m.useQueryClient)(),{data:i}=(0,S.a)(),{data:l}=(0,q.t)(o.collateralSymbol),{data:p}=(0,L.mM)(i?.address),{exec:c,settle:u}=(({accountId:e,poolId:t,collateralTypeAddress:a,debtChange:r,balance:o,availableUSDCollateral:s})=>{const[n,i]=(0,v.useReducer)(A.I,A.E),{data:l}=(0,h.a)(),{data:p}=(0,S.a)(),{data:c}=(0,k.L)(),d=(0,b.mx)(),{network:u}=(0,b.LN)(),{gasSpeed:y}=(0,C.jU)(),g=(0,b.yL)(),E=(0,m.useMutation)({mutationFn:async()=>{if(!d||!u||!g)throw new Error("No signer or network");if(!(l&&t&&e&&a&&p&&c))return;if(!o)return;if(!s)return;if(r.eq(0))return;const n=r.abs(),v=n.sub(s);try{i({type:"prompting"});const r=v.lte(0)?void 0:l.populateTransaction.deposit(w.O$.from(e),p.address,v.toBN()),o=l.populateTransaction.burnUsd(w.O$.from(e),w.O$.from(t),a,n.toBN()),s=Promise.all([r,o].filter(I._)),h=await d.getAddress(),m=(0,P.$)(c,u.isTestnet).then((e=>(0,P.x)(h,c,e))),[b,A,C]=await Promise.all([s,(0,x.o)({provider:g}),m]),S=C.concat(b),k=await(0,T.dI)(u,S,"useRepay",l.interface),E=(0,f.F)({gasLimit:k.gasLimit,gasPrices:A,gasSpeed:y}),R=await d.sendTransaction({...k,...E});i({type:"pending",payload:{txnHash:R.hash}}),await R.wait(),i({type:"success"})}catch(e){throw i({type:"error",payload:{error:e}}),e}}});return{mutation:E,txnState:n,settle:()=>i({type:"settled"}),isLoading:E.isPending,exec:E.mutateAsync}})({accountId:o.accountId,poolId:o.poolId,collateralTypeAddress:l?.tokenAddress,debtChange:r,availableUSDCollateral:a,balance:p}),{exec:y,settle:O}=(({accountId:e,poolId:t,collateralTypeAddress:a,debtChange:r,availableUSDCollateral:o})=>{const[s,n]=(0,v.useReducer)(A.I,A.E),{data:i}=(0,h.a)(),{data:l}=(0,S.a)(),{data:p}=(0,te.b)(),{data:c}=(0,oe.Y)(),d=(0,b.mx)(),{network:u}=(0,b.LN)(),{gasSpeed:y}=(0,C.jU)(),g=(0,b.yL)(),k=(0,m.useMutation)({mutationFn:async()=>{if(!d||!u||!g)throw new Error("No signer or network");if(!(i&&t&&e&&a&&l&&p))return;if(!o)return;if(r.eq(0))return;const s=r.abs(),v=s.sub(o),h=v.gt(0)?(0,re.vz)(v.toString(),6):w.O$.from(0);try{n({type:"prompting"});const r=v.gt(0)?p.populateTransaction.wrap(ae.Ds,h,0):void 0,o=(0,ae.Hb)(u.id),m=new X.CH(o,j.P,d),b=v.gt(0)?m.populateTransaction.approve(p.address,v.toBN()):void 0,A=v.gt(0)?p.populateTransaction.sell(ae.Ds,v.toBN(),0,ee.d):void 0,C=new X.CH(l.address,j.P,d),S=v.gt(0)?C.populateTransaction.approve(i.address,v.toBN()):void 0,k=v.lte(0)?void 0:i.populateTransaction.deposit(w.O$.from(e),l.address,v.toBN()),P=i.populateTransaction.burnUsd(w.O$.from(e),w.O$.from(t),a,s.toBN()),E=Promise.all([r,b,A,S,k,P].filter(I._)),[R,q]=await Promise.all([E,(0,x.o)({provider:g})]);c&&R.push(c);const U=await(0,T.dI)(u,R,"useRepay",i.interface),L=(0,f.F)({gasLimit:U.gasLimit,gasPrices:q,gasSpeed:y}),N=await d.sendTransaction({...U,...L});n({type:"pending",payload:{txnHash:N.hash}}),await N.wait(),n({type:"success"})}catch(e){throw n({type:"error",payload:{error:e}}),e}}});return{mutation:k,txnState:s,settle:()=>n({type:"settled"}),isLoading:k.isPending,exec:k.mutateAsync}})({accountId:o.accountId,poolId:o.poolId,collateralTypeAddress:l?.tokenAddress,debtChange:r,availableUSDCollateral:a}),D=(0,d.p)({isClosable:!0,duration:9e3}),{data:Y}=(0,h.a)(),{data:F}=(0,te.b)(),H=(0,U.o)(Y),Q=r.abs().sub(a||0),V=(0,ae.Yz)(s?.id,s?.preset)?(0,ae.sm)(s?.id):i?.address,{approve:J,requireApproval:ie}=(0,j.y)({contractAddress:V,amount:(0,ae.Yz)(s?.id,s?.preset)?(0,re.vz)(Q.toString(),6):Q.toBN(),spender:(0,ae.Yz)(s?.id,s?.preset)?F?.address:Y?.address}),[le,pe]=(0,N.e)(W,{services:{[Z]:async()=>{try{D({title:"Approve sUSD for transfer",description:"The next transaction will repay your debt.",status:"info"}),await J(Boolean(le.context.infiniteApproval))}catch(e){const t=H(e);throw t&&console.error(new Error(t.name),t),D.closeAll(),D({title:"Approval failed",description:t?(0,se.jsx)(g.M,{contractError:t}):"Please try again.",status:"error"}),Error("Approve failed",{cause:e})}},[G]:async()=>{try{D.closeAll(),D({title:"Repaying..."}),(0,ae.Yz)(s?.id,s?.preset)?await y():await c(),await Promise.all([n.invalidateQueries({queryKey:[`${s?.id}-${s?.preset}`,"TokenBalance"]}),n.invalidateQueries({queryKey:[`${s?.id}-${s?.preset}`,"Allowance"]}),n.invalidateQueries({queryKey:[`${s?.id}-${s?.preset}`,"LiquidityPosition"]})]),D.closeAll(),D({title:"Success",description:"Your debt has been repaid.",status:"success",duration:5e3})}catch(e){const t=H(e);throw t&&console.error(new Error(t.name),t),D({title:"Could not complete repaying",description:t?(0,se.jsx)(g.M,{contractError:t}):"Please try again.",status:"error"}),Error("Repay failed",{cause:e})}}}}),ce=Q.gt(0);(0,v.useEffect)((()=>{pe($,{requireApproval:ie&&ce})}),[ce,ie,pe]);const de=(0,v.useCallback)((async()=>{if(le.matches(K))return pe(M),void e();le.context.error?pe(B):pe(z)}),[e,pe,le]);return o.poolId&&o.accountId&&l?(0,se.jsx)(ne,{state:le,onSubmit:de,debtChange:r,setInfiniteApproval:e=>{pe(_,{infiniteApproval:e})},onClose:()=>{u(),O(),e()},isOpen:t}):null},le=ie}}]);
//# sourceMappingURL=2899.1cadf74a.js.map