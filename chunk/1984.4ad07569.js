"use strict";(globalThis.webpackChunk_snx_v3_liquidity=globalThis.webpackChunk_snx_v3_liquidity||[]).push([[1984],{91984:(e,t,a)=>{a.r(t),a.d(t,{RepayModal:()=>le,RepayModalUi:()=>ie,default:()=>ce});var r=a(75429),o=a(11082),s=a(59176),n=a(74008),i=a(84626),l=a(70065),c=a(38035),p=a(56317),d=a(45071),u=a(42219),h=a(99581),y=a(96596),v=a(77528),f=a(13797),g=a(25042),b=a(42383),x=a(908),m=a(64996),A=a(85619),w=a(40109),C=a(34367),j=a(89536),S=a(18498),k=a(37330),T=a(17716),E=a(29542),I=a(99),R=a(35834),P=a(95772),$=a(7226),q=a(73635),D=a(37888),O=a(28145),U=a(10528),_=a(50986),N=a(51906),L=a(2784);var B=a(5348),M=a(97737),z=a(21849),Y=a(9875),F=a(97386);const H="SET_REQUIRE_APPROVAL",Q="SET_INFINITE_APPROVAL",K="RETRY",V="RUN",W="RESET",G="idle",X="approve",J="repay",Z="failed",ee="success",te={[X]:X,[J]:J},ae="approveSUSD",re="executeRepay",oe={error:null,requireApproval:!1,infiniteApproval:!1},se=(0,Y.C)({id:"RepayMachine",initial:G,predictableActionArguments:!0,context:oe,on:{[V]:{target:J,actions:(0,F.f0)({error:e=>oe.error,requireApproval:e=>oe.requireApproval,infiniteApproval:e=>oe.infiniteApproval})},[H]:{actions:(0,F.f0)({requireApproval:(e,t)=>t.requireApproval})},[Q]:{actions:(0,F.f0)({infiniteApproval:(e,t)=>t.infiniteApproval})}},states:{[G]:{on:{[V]:[{target:X,cond:e=>e.requireApproval},{target:J}]}},[X]:{invoke:{src:ae,onDone:{target:J},onError:{target:Z,actions:(0,F.f0)({error:(e,t)=>({error:t.data,step:te.approve})})}}},[J]:{invoke:{src:re,onDone:{target:ee},onError:{target:Z,actions:(0,F.f0)({error:(e,t)=>({error:t.data,step:te.repay})})}}},[Z]:{on:{[K]:[{target:X,cond:e=>e.error?.step===te.approve,actions:(0,F.f0)({error:e=>null})},{target:J,cond:e=>e.error?.step===te.repay,actions:(0,F.f0)({error:e=>null})}]}},[ee]:{}}});var ne=a(52322);const ie=({symbol:e,onClose:t,isOpen:a,debtChange:l,state:c,onSubmit:p,setInfiniteApproval:u})=>{const h=c.matches(X)||c.matches(J),{infiniteApproval:y,requireApproval:v,error:f}=c.context;if(a)return c.matches(ee)?(0,ne.jsx)(z.s,{onClose:p,title:"Debt successfully Updated",subline:(0,ne.jsxs)(ne.Fragment,{children:["Your ",(0,ne.jsx)("b",{children:"Debt"})," has been updated, read more about it in the"," ",(0,ne.jsx)(o.r,{href:"https://docs.synthetix.io/v/synthetix-v3-user-documentation",target:"_blank",color:"cyan.500",children:"Synthetix V3 Documentation"})]}),alertText:(0,ne.jsxs)(ne.Fragment,{children:[(0,ne.jsx)("b",{children:"Debt"})," successfully Updated"]})}):(0,ne.jsxs)("div",{"data-cy":"repay multistep",children:[(0,ne.jsxs)(s.x,{color:"gray.50",fontSize:"20px",fontWeight:700,children:[(0,ne.jsx)(r.R,{cursor:"pointer",onClick:t,mr:2}),"Manage Debt"]}),(0,ne.jsx)(n.i,{my:4}),(0,ne.jsx)(g.P0,{step:1,title:`Approve ${e} transfer`,status:{failed:f?.step===X,success:!v||c.matches(ee),loading:c.matches(X)&&!f},checkboxLabel:v?`Approve unlimited ${e} transfers to Synthetix.`:void 0,checkboxProps:{isChecked:y,onChange:e=>u(e.target.checked)}}),(0,ne.jsx)(g.P0,{step:2,title:"Repay",subtitle:(0,ne.jsxs)(s.x,{children:["Repay ",(0,ne.jsx)(d.$,{value:l.abs(),suffix:` ${e}`})]}),status:{failed:f?.step===J,success:c.matches(ee),loading:c.matches(J)&&!f}}),(0,ne.jsx)(i.z,{isDisabled:h,onClick:p,width:"100%",mt:"6","data-cy":"repay confirm button",children:(()=>{switch(!0){case Boolean(f):return"Retry";case h:return"Processing...";case c.matches(ee):return"Continue";default:return"Execute Transaction"}})()})]})},le=({onClose:e,isOpen:t,availableCollateral:a})=>{const{debtChange:r,setDebtChange:o}=(0,L.useContext)(f.n),s=(0,j.UO)(),{network:i}=(0,x.LN)(),d=(0,O.useQueryClient)(),{data:g}=(0,m.t)(s.collateralSymbol),{data:z}=(0,q.p)(),{data:Y}=(0,B.mM)(z?.address),{exec:F,settle:G}=(0,S.f)({accountId:s.accountId,poolId:s.poolId,collateralTypeAddress:g?.tokenAddress,debtChange:r,availableUSDCollateral:a,balance:Y}),{exec:X,settle:J}=(({accountId:e,poolId:t,collateralTypeAddress:a,debtChange:r,availableUSDCollateral:o,collateralSymbol:s})=>{const[n,i]=(0,L.useReducer)(T.I,T.E),{data:l}=(0,w.a)(),{data:c}=(0,q.p)(),{data:p}=(0,$.b)(),{data:d,refetch:u}=(0,E.Y_)(),{data:h}=(0,C.X)(),f=(0,x.mx)(),{network:g}=(0,x.LN)(),{gasSpeed:m}=(0,P.jU)(),A=(0,x.yL)(),j=(0,O.useMutation)({mutationFn:async()=>{if(!f||!g||!A)throw new Error("No signer or network");if(!(l&&t&&e&&a&&c&&p&&h?.sUSD))return;if(!o)return;if(r.eq(0))return;const n=r.abs(),u=n.sub(o),x=u.gt(0)?(0,y.vz)(u.toString(),6):U.O$.from(0);try{i({type:"prompting"});const r=(0,v.$l)(s),o=x.gt(0)?p.populateTransaction.wrap(r,x,0):void 0,h=new _.CH(a,b.P,f),y=u.gt(0)?h.populateTransaction.approve(p.address,u.toBN()):void 0,w=u.gt(0)?p.populateTransaction.sell(r,u.toBN(),0,N.d):void 0,C=new _.CH(c.address,b.P,f),j=u.gt(0)?C.populateTransaction.approve(l.address,u.toBN()):void 0,S=u.lte(0)?void 0:l.populateTransaction.deposit(U.O$.from(e),c.address,u.toBN()),T=l.populateTransaction.burnUsd(U.O$.from(e),U.O$.from(t),a,n.toBN()),E=Promise.all([o,y,w,j,S,T].filter(k._)),[P,$]=await Promise.all([E,(0,R.o)({provider:A})]);d&&P.unshift(d);const q=await f.getAddress(),O=await(0,D.dI)(g,P,"useRepay",q),L=(0,I.F)({gasLimit:O.gasLimit,gasPrices:$,gasSpeed:m}),B=await f.sendTransaction({...O,...L});i({type:"pending",payload:{txnHash:B.hash}}),await B.wait(),i({type:"success"})}catch(e){throw i({type:"error",payload:{error:e}}),e}},onSuccess:()=>{u()}});return{mutation:j,txnState:n,settle:()=>i({type:"settled"}),isLoading:j.isPending,exec:j.mutateAsync}})({accountId:s.accountId,poolId:s.poolId,collateralTypeAddress:g?.tokenAddress,debtChange:r,availableUSDCollateral:a}),Z=(0,l.p)({isClosable:!0,duration:9e3}),{data:te}=(0,w.a)(),{data:oe}=(0,$.b)(),le=(0,A.o)(),ce=r.abs().sub(a||0),{data:pe}=(0,C.H)((0,v.$l)(s.collateralSymbol)),de=(0,v.Yz)(i?.id,i?.preset),ue=de?pe:z?.address,{approve:he,requireApproval:ye}=(0,b.y)({contractAddress:ue,amount:de?(0,y.vz)(ce.toString(),6):ce.toBN(),spender:de?oe?.address:te?.address}),[ve,fe]=(0,M.e)(se,{services:{[ae]:async()=>{try{Z({title:`Approve ${z?.symbol} for transfer`,description:"The next transaction will repay your debt.",status:"info",variant:"left-accent"}),await he(Boolean(ve.context.infiniteApproval))}catch(e){const t=le(e);throw t&&console.error(new Error(t.name),t),Z.closeAll(),Z({title:"Approval failed",description:t?(0,ne.jsx)(h.M,{contractError:t}):"Please try again.",status:"error",variant:"left-accent"}),Error("Approve failed",{cause:e})}},[re]:async()=>{try{Z.closeAll(),Z({title:"Repaying...",variant:"left-accent"}),(0,v.Yz)(i?.id,i?.preset)?await X():await F(),await Promise.all([d.invalidateQueries({queryKey:[`${i?.id}-${i?.preset}`,"TokenBalance"]}),d.invalidateQueries({queryKey:[`${i?.id}-${i?.preset}`,"Allowance"]}),d.invalidateQueries({queryKey:[`${i?.id}-${i?.preset}`,"LiquidityPosition"]})]),o(u.GH),Z.closeAll(),Z({title:"Success",description:"Your debt has been repaid.",status:"success",duration:5e3,variant:"left-accent"})}catch(e){const t=le(e);throw t&&console.error(new Error(t.name),t),Z({title:"Could not complete repaying",description:t?(0,ne.jsx)(h.M,{contractError:t}):"Please try again.",status:"error",variant:"left-accent"}),Error("Repay failed",{cause:e})}}}}),ge=ce.gt(0);(0,L.useEffect)((()=>{fe(H,{requireApproval:ye&&ge})}),[ge,ye,fe]);const be=(0,L.useCallback)((async()=>{if(ve.matches(ee))return fe(W),void e();ve.context.error?fe(K):fe(V)}),[e,fe,ve]);return s.poolId&&s.accountId&&g&&z?(0,ne.jsx)(ie,{state:ve,onSubmit:be,debtChange:r,setInfiniteApproval:e=>{fe(Q,{infiniteApproval:e})},onClose:()=>{G(),J(),e()},isOpen:t,symbol:de?g.symbol:z?.symbol}):(0,ne.jsxs)(c.k,{gap:4,flexDirection:"column",children:[(0,ne.jsx)(p.O,{maxW:"232px",width:"100%",height:"20px"}),(0,ne.jsx)(n.i,{my:4}),(0,ne.jsx)(p.O,{width:"100%",height:"20px"}),(0,ne.jsx)(p.O,{width:"100%",height:"20px"})]})},ce=le}}]);
//# sourceMappingURL=1984.4ad07569.js.map