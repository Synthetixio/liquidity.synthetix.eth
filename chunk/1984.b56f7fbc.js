"use strict";(globalThis.webpackChunk_snx_v3_liquidity=globalThis.webpackChunk_snx_v3_liquidity||[]).push([[1984],{91984:(e,t,a)=>{a.r(t),a.d(t,{RepayModal:()=>le,RepayModalUi:()=>ie,default:()=>ce});var r=a(11082),o=a(59176),s=a(74008),n=a(84626),i=a(70065),l=a(38035),c=a(56317),p=a(45071),d=a(99581),u=a(96596),h=a(77528),v=a(13797),y=a(25042),f=a(42383),g=a(76885),x=a(64996),b=a(97721),m=a(40109),A=a(34367),w=a(89536),C=a(18498),j=a(2784),S=a(99),k=a(28145),T=a(17716),D=a(10528),E=a(50986),I=a(51906),R=a(35834),P=a(95772),q=a(73635),U=a(37330),$=a(60341),N=a(7226),O=a(82227);var _=a(55576),L=a(97737),z=a(9875),B=a(97386);const Y="SET_REQUIRE_APPROVAL",M="SET_INFINITE_APPROVAL",F="RETRY",Q="RUN",H="RESET",K="idle",V="approve",W="repay",X="failed",G="success",J={[V]:V,[W]:W},Z="approveSUSD",ee="executeRepay",te={error:null,requireApproval:!1,infiniteApproval:!1},ae=(0,z.C)({id:"RepayMachine",initial:K,predictableActionArguments:!0,context:te,on:{[Q]:{target:W,actions:(0,B.f0)({error:e=>te.error,requireApproval:e=>te.requireApproval,infiniteApproval:e=>te.infiniteApproval})},[Y]:{actions:(0,B.f0)({requireApproval:(e,t)=>t.requireApproval})},[M]:{actions:(0,B.f0)({infiniteApproval:(e,t)=>t.infiniteApproval})}},states:{[K]:{on:{[Q]:[{target:V,cond:e=>e.requireApproval},{target:W}]}},[V]:{invoke:{src:Z,onDone:{target:W},onError:{target:X,actions:(0,B.f0)({error:(e,t)=>({error:t.data,step:J.approve})})}}},[W]:{invoke:{src:ee,onDone:{target:G},onError:{target:X,actions:(0,B.f0)({error:(e,t)=>({error:t.data,step:J.repay})})}}},[X]:{on:{[F]:[{target:V,cond:e=>e.error?.step===J.approve,actions:(0,B.f0)({error:e=>null})},{target:W,cond:e=>e.error?.step===J.repay,actions:(0,B.f0)({error:e=>null})}]}},[G]:{}}});var re=a(75429),oe=a(21849),se=a(88383),ne=a(52322);const ie=({onClose:e,isOpen:t,debtChange:a,state:i,onSubmit:l,setInfiniteApproval:c})=>{const d=i.matches(V)||i.matches(W),{infiniteApproval:u,requireApproval:v,error:f}=i.context,{data:x}=(0,q.p)(),{network:b}=(0,g.LN)(),m=(0,h.Yz)(b?.id,b?.preset)?" USDC":` ${x?.symbol}`;if(t)return i.matches(G)?(0,ne.jsx)(oe.s,{onClose:l,title:"Debt successfully Updated",subline:(0,ne.jsxs)(ne.Fragment,{children:["Your ",(0,ne.jsx)("b",{children:"Debt"})," has been updated, read more about it in the"," ",(0,ne.jsx)(r.r,{href:"https://docs.synthetix.io/v/synthetix-v3-user-documentation",target:"_blank",color:"cyan.500",children:"Synthetix V3 Documentation"})]}),alertText:(0,ne.jsxs)(ne.Fragment,{children:[(0,ne.jsx)("b",{children:"Debt"})," successfully Updated"]})}):(0,ne.jsxs)("div",{children:[(0,ne.jsxs)(o.x,{color:"gray.50",fontSize:"20px",fontWeight:700,children:[(0,ne.jsx)(re.R,{cursor:"pointer",onClick:e,mr:2}),"Manage Debt"]}),(0,ne.jsx)(s.i,{my:4}),(0,ne.jsx)(y.P0,{step:1,title:`Approve ${m} transfer`,status:{failed:f?.step===V,success:!v||i.matches(G),loading:i.matches(V)&&!f},checkboxLabel:v?`Approve unlimited ${m} transfers to Synthetix.`:void 0,checkboxProps:{isChecked:u,onChange:e=>c(e.target.checked)}}),(0,ne.jsx)(y.P0,{step:2,title:"Repay",subtitle:(0,ne.jsxs)(o.x,{children:["Repay ",(0,ne.jsx)(p.$,{value:a.abs(),suffix:` ${m}`})]}),status:{failed:f?.step===W,success:i.matches(G),loading:i.matches(W)&&!f}}),(0,ne.jsx)(n.z,{isDisabled:d,onClick:l,width:"100%",mt:"6","data-testid":"repay confirm button",children:(()=>{switch(!0){case Boolean(f):return"Retry";case d:return"Processing...";case i.matches(G):return"Continue";default:return"Execute Transaction"}})()})]})},le=({onClose:e,isOpen:t,availableCollateral:a})=>{const{debtChange:r,setDebtChange:o}=(0,j.useContext)(v.n),n=(0,w.UO)(),{network:p}=(0,g.LN)(),{data:y}=(0,A.X)(),z=(0,k.useQueryClient)(),{data:B}=(0,x.t)(n.collateralSymbol),{data:K}=(0,q.p)(),{data:V}=(0,_.mM)(K?.address),{exec:W,settle:X}=(0,C.f)({accountId:n.accountId,poolId:n.poolId,collateralTypeAddress:B?.tokenAddress,debtChange:r,availableUSDCollateral:a,balance:V}),{exec:J,settle:te}=(({accountId:e,poolId:t,collateralTypeAddress:a,debtChange:r,availableUSDCollateral:o})=>{const[s,n]=(0,j.useReducer)(T.I,T.E),{data:i}=(0,m.a)(),{data:l}=(0,q.p)(),{data:c}=(0,N.b)(),{data:p}=(0,O.Y_)(),{data:d}=(0,A.X)(),v=(0,g.mx)(),{network:y}=(0,g.LN)(),{gasSpeed:x}=(0,P.jU)(),b=(0,g.yL)(),w=(0,k.useMutation)({mutationFn:async()=>{if(!v||!y||!b)throw new Error("No signer or network");if(!(i&&t&&e&&a&&l&&c&&d?.sUSD))return;if(!o)return;if(r.eq(0))return;const s=r.abs(),g=s.sub(o),m=g.gt(0)?(0,u.vz)(g.toString(),6):D.O$.from(0);try{n({type:"prompting"});const r=g.gt(0)?c.populateTransaction.wrap(h.Ds,m,0):void 0,o=d?.sUSD,u=new E.CH(o,f.P,v),A=g.gt(0)?u.populateTransaction.approve(c.address,g.toBN()):void 0,w=g.gt(0)?c.populateTransaction.sell(h.Ds,g.toBN(),0,I.d):void 0,C=new E.CH(l.address,f.P,v),j=g.gt(0)?C.populateTransaction.approve(i.address,g.toBN()):void 0,k=g.lte(0)?void 0:i.populateTransaction.deposit(D.O$.from(e),l.address,g.toBN()),T=i.populateTransaction.burnUsd(D.O$.from(e),D.O$.from(t),a,s.toBN()),P=Promise.all([r,A,w,j,k,T].filter(U._)),[q,N]=await Promise.all([P,(0,R.o)({provider:b})]);p&&q.push(p);const O=await v.getAddress(),_=await(0,$.dI)(y,q,"useRepay",O),L=(0,S.F)({gasLimit:_.gasLimit,gasPrices:N,gasSpeed:x}),z=await v.sendTransaction({..._,...L});n({type:"pending",payload:{txnHash:z.hash}}),await z.wait(),n({type:"success"})}catch(e){throw n({type:"error",payload:{error:e}}),e}}});return{mutation:w,txnState:s,settle:()=>n({type:"settled"}),isLoading:w.isPending,exec:w.mutateAsync}})({accountId:n.accountId,poolId:n.poolId,collateralTypeAddress:B?.tokenAddress,debtChange:r,availableUSDCollateral:a}),re=(0,i.p)({isClosable:!0,duration:9e3}),{data:oe}=(0,m.a)(),{data:le}=(0,N.b)(),ce=(0,b.o)(oe),pe=r.abs().sub(a||0),de=(0,h.Yz)(p?.id,p?.preset)?y?.USDC:K?.address,{approve:ue,requireApproval:he}=(0,f.y)({contractAddress:de,amount:(0,h.Yz)(p?.id,p?.preset)?(0,u.vz)(pe.toString(),6):pe.toBN(),spender:(0,h.Yz)(p?.id,p?.preset)?le?.address:oe?.address}),[ve,ye]=(0,L.e)(ae,{services:{[Z]:async()=>{try{re({title:`Approve ${K?.symbol} for transfer`,description:"The next transaction will repay your debt.",status:"info",variant:"left-accent"}),await ue(Boolean(ve.context.infiniteApproval))}catch(e){const t=ce(e);throw t&&console.error(new Error(t.name),t),re.closeAll(),re({title:"Approval failed",description:t?(0,ne.jsx)(d.M,{contractError:t}):"Please try again.",status:"error",variant:"left-accent"}),Error("Approve failed",{cause:e})}},[ee]:async()=>{try{re.closeAll(),re({title:"Repaying...",variant:"left-accent"}),(0,h.Yz)(p?.id,p?.preset)?await J():await W(),await Promise.all([z.invalidateQueries({queryKey:[`${p?.id}-${p?.preset}`,"TokenBalance"]}),z.invalidateQueries({queryKey:[`${p?.id}-${p?.preset}`,"Allowance"]}),z.invalidateQueries({queryKey:[`${p?.id}-${p?.preset}`,"LiquidityPosition"]})]),o(se.GH),re.closeAll(),re({title:"Success",description:"Your debt has been repaid.",status:"success",duration:5e3,variant:"left-accent"})}catch(e){const t=ce(e);throw t&&console.error(new Error(t.name),t),re({title:"Could not complete repaying",description:t?(0,ne.jsx)(d.M,{contractError:t}):"Please try again.",status:"error",variant:"left-accent"}),Error("Repay failed",{cause:e})}}}}),fe=pe.gt(0);(0,j.useEffect)((()=>{ye(Y,{requireApproval:he&&fe})}),[fe,he,ye]);const ge=(0,j.useCallback)((async()=>{if(ve.matches(G))return ye(H),void e();ve.context.error?ye(F):ye(Q)}),[e,ye,ve]);return n.poolId&&n.accountId&&B?(0,ne.jsx)(ie,{state:ve,onSubmit:ge,debtChange:r,setInfiniteApproval:e=>{ye(M,{infiniteApproval:e})},onClose:()=>{X(),te(),e()},isOpen:t}):(0,ne.jsxs)(l.k,{gap:4,flexDirection:"column",children:[(0,ne.jsx)(c.O,{maxW:"232px",width:"100%",height:"20px"}),(0,ne.jsx)(s.i,{my:4}),(0,ne.jsx)(c.O,{width:"100%",height:"20px"}),(0,ne.jsx)(c.O,{width:"100%",height:"20px"})]})},ce=le}}]);
//# sourceMappingURL=1984.b56f7fbc.js.map