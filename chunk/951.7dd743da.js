"use strict";(globalThis.webpackChunk_snx_v3_liquidity=globalThis.webpackChunk_snx_v3_liquidity||[]).push([[951],{70951:(e,t,a)=>{a.r(t),a.d(t,{UndelegateModal:()=>J,UndelegateModalUi:()=>G,default:()=>V});var o=a(66901),r=a(26468),l=a(19433),s=a(54326),n=a(2338),i=a(97217),c=a(59176),d=a(84626),u=a(70065),m=a(2784),g=a(19299),p=a(45071),h=a(25042),y=a(79929),x=a(89536),b=a(9875),w=a(97386);const f="SET_AMOUNT",C="SET_COLLATERAL_SYMBOL",v="RETRY",S="RUN",T="RESET",j="idle",E="undelegate",k="failed",A="success",L={[E]:E},O="undelegate",R={amount:(0,y.wei)(0),error:null,collateralSymbol:void 0},_=(0,b.C)({id:"UndelegateMachine",initial:j,predictableActionArguments:!0,context:R,on:{[T]:{target:j,actions:(0,w.f0)({amount:e=>R.amount,error:e=>R.error,collateralSymbol:e=>R.collateralSymbol})},[f]:{actions:(0,w.f0)({amount:(e,t)=>t.amount})},[C]:{actions:(0,w.f0)({collateralSymbol:(e,t)=>t.symbol})}},states:{[j]:{on:{[S]:[{target:E,cond:e=>e.amount.gt(0)}]}},[E]:{invoke:{src:O,onError:{target:k,actions:(0,w.f0)({error:(e,t)=>({error:t.data,step:L.undelegate})})},onDone:[{target:A}]}},[k]:{on:{[v]:[{target:E,cond:e=>e.error?.step===L.undelegate,actions:(0,w.f0)({error:e=>null})}]}},[A]:{}}});var P=a(97737),U=a(40109),q=a(28145),I=a(76885),M=a(17716),N=a(10528),$=a(99),B=a(35834),D=a(95772),z=a(860),F=a(51686),Q=a(95522);var Y=a(13797),H=a(97721),K=a(99581),Z=a(52322);const G=({amount:e,isOpen:t,onClose:a,collateralType:u,onSubmit:m,state:g,error:y})=>{const x=g.matches(E);return(0,Z.jsxs)(o.u_,{size:"lg",isOpen:t,onClose:a,closeOnOverlayClick:!1,children:[(0,Z.jsx)(r.Z,{}),(0,Z.jsxs)(l.h,{bg:"black",color:"white","data-testid":"undelegate modal",children:[(0,Z.jsx)(s.x,{children:"Complete this action"}),(0,Z.jsx)(n.o,{}),(0,Z.jsxs)(i.f,{children:[(0,Z.jsx)(c.x,{mb:"2",children:"Please execute the following transactions:"}),(0,Z.jsx)(h.P0,{step:1,title:"Remove collateral",subtitle:(0,Z.jsxs)(c.x,{as:"div",children:[(0,Z.jsx)(p.$,{value:e,suffix:` ${u?.symbol}`})," will be removed from the pool."]}),status:{failed:Boolean(y?.step===E),disabled:e.eq(0),success:g.matches(A),loading:g.matches(E)&&!y}}),(0,Z.jsx)(d.z,{isDisabled:x,onClick:m,width:"100%",my:"4","data-testid":"undelegate confirm button",children:(()=>{switch(!0){case Boolean(y):return"Retry";case x:return"Processing...";case g.matches(A):return"Done";default:return"Start"}})()})]})]})]})},J=({onClose:e,isOpen:t,liquidityPosition:a})=>{const o=(0,x.UO)(),{collateralChange:r}=(0,m.useContext)(Y.n),{network:l}=(0,I.LN)(),s=(0,q.useQueryClient)(),{data:n}=(0,g.t)(o.collateralSymbol),i=(0,u.p)({isClosable:!0,duration:9e3}),c=a?.collateralAmount||(0,y.wei)(0),{exec:d}=(({accountId:e,poolId:t,collateralTypeAddress:a,collateralChange:o,currentCollateral:r})=>{const[l,s]=(0,m.useReducer)(M.I,M.E),{data:n}=(0,U.a)(),i=(0,I.mx)(),{gasSpeed:c}=(0,D.jU)(),d=(0,I.yL)(),{data:u}=(0,F.L)(),{network:g}=(0,I.LN)(),p=(0,q.useMutation)({mutationFn:async()=>{if(!i||!g||!d)throw new Error("No signer or network");if(n&&t&&a&&u&&!o.eq(0)&&!r.eq(0))try{s({type:"prompting"});const l=n.populateTransaction.delegateCollateral(N.O$.from(e),N.O$.from(t),a,r.add(o).toBN(),(0,y.wei)(1).toBN()),m=await i.getAddress(),p=(0,Q.$)(u,g.isTestnet).then((e=>(0,Q.x)(m,u,e))),[h,x,b]=await Promise.all([l,(0,B.o)({provider:d}),p]),w=b.concat(h),f=await(0,z.dI)(g,w,"useUndelegate",n.interface),C=(0,$.F)({gasLimit:f.gasLimit,gasPrices:x,gasSpeed:c}),v=await i.sendTransaction({...f,...C});s({type:"pending",payload:{txnHash:v.hash}}),await v.wait(),s({type:"success"})}catch(e){throw s({type:"error",payload:{error:e}}),e}}});return{mutation:p,txnState:l,settle:()=>s({type:"settled"}),isLoading:p.isPending,exec:p.mutateAsync}})({accountId:o.accountId,poolId:o.poolId,collateralTypeAddress:a?.tokenAddress,collateralChange:r,currentCollateral:c}),{data:p}=(0,U.a)(),h=(0,H.o)(p),[b,w]=(0,P.e)(_,{context:{amount:r.abs()},services:{[O]:async()=>{try{await d(),await s.invalidateQueries({queryKey:[`${l?.id}-${l?.preset}`,"LiquidityPosition"],exact:!1})}catch(e){const t=h(e);throw t&&console.error(new Error(t.name),t),i.closeAll(),i({title:"Remove collateral failed",description:t?(0,Z.jsx)(K.M,{contractError:t}):"Please try again.",status:"error"}),Error("Remove collateral failed",{cause:e})}}}}),j=r.toString();(0,m.useEffect)((()=>{w(f,{amount:(0,y.wei)(j).abs()})}),[j,w]),(0,m.useEffect)((()=>{w(C,{symbol:(0,y.wei)(j).abs()})}),[j,w]);const E=(0,m.useCallback)((async()=>{if(b.matches(A))return w(T),void e();b.context.error?w(v):w(S)}),[e,w,b]);return(0,Z.jsx)(G,{amount:b.context.amount,isOpen:t,onClose:e,collateralType:n,state:b,error:b.context.error,onSubmit:E})},V=J}}]);
//# sourceMappingURL=951.7dd743da.js.map