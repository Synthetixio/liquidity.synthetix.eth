{"version":3,"file":"chunk/1984.b56f7fbc.js","mappings":"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","sources":["webpack://@snx-v3/liquidity/../components/RepayModal/RepayMachine.ts","webpack://@snx-v3/liquidity/../components/RepayModal/RepayModal.tsx","webpack://@snx-v3/liquidity/../lib/useRepayBaseAndromeda/useRepayBaseAndromeda.tsx","webpack://@snx-v3/liquidity/../components/RepayModal/index.ts"],"sourcesContent":["import { createMachine, assign } from 'xstate';\n\nexport const Events = {\n  SET_REQUIRE_APPROVAL: 'SET_REQUIRE_APPROVAL',\n  SET_INFINITE_APPROVAL: 'SET_INFINITE_APPROVAL',\n  RETRY: 'RETRY',\n  RUN: 'RUN',\n  SUCCESS: 'SUCCESS',\n  FAILURE: 'FAILURE',\n  RESET: 'RESET',\n} as const;\n\nexport const State = {\n  idle: 'idle',\n  approve: 'approve',\n  repay: 'repay',\n  failed: 'failed',\n  success: 'success',\n} as const;\n\nconst FailedSteps = {\n  [State.approve]: State.approve,\n  [State.repay]: State.repay,\n} as const;\n\nexport const ServiceNames = {\n  approveSUSD: 'approveSUSD',\n  executeRepay: 'executeRepay',\n} as const;\n\ntype Context = {\n  error: {\n    error: Error;\n    step: keyof typeof FailedSteps;\n  } | null;\n  requireApproval: boolean;\n  infiniteApproval: boolean;\n};\n\ntype EventNamesType = typeof Events;\ntype RepayEvents =\n  | { type: EventNamesType['SET_REQUIRE_APPROVAL']; requireApproval: boolean }\n  | { type: EventNamesType['SET_INFINITE_APPROVAL']; infiniteApproval: boolean }\n  | { type: EventNamesType['RETRY'] }\n  | { type: EventNamesType['RUN'] }\n  | { type: EventNamesType['SUCCESS'] }\n  | { type: EventNamesType['FAILURE'] }\n  | { type: EventNamesType['RESET'] };\n\ntype StateType = typeof State;\ntype MachineState =\n  | {\n      value: StateType['idle'];\n      context: Context & { error: null };\n    }\n  | {\n      value: StateType['approve'];\n      context: Context & { error: null };\n    }\n  | {\n      value: StateType['repay'];\n      context: Context & { error: null };\n    }\n  | {\n      value: StateType['failed'];\n      context: Context & { error: { error: Error; step: keyof typeof FailedSteps } };\n    }\n  | {\n      value: StateType['success'];\n      context: Context & {\n        error: null;\n      };\n    };\n\nconst initialContext = {\n  error: null,\n  requireApproval: false,\n  infiniteApproval: false,\n};\n\nexport const RepayMachine = createMachine<Context, RepayEvents, MachineState>({\n  id: 'RepayMachine',\n  initial: State.idle,\n  predictableActionArguments: true,\n  context: initialContext,\n  on: {\n    [Events.RUN]: {\n      target: State.repay,\n      actions: assign({\n        error: (_) => initialContext.error,\n        requireApproval: (_) => initialContext.requireApproval,\n        infiniteApproval: (_) => initialContext.infiniteApproval,\n      }),\n    },\n    [Events.SET_REQUIRE_APPROVAL]: {\n      actions: assign({ requireApproval: (_context, event) => event.requireApproval }),\n    },\n\n    [Events.SET_INFINITE_APPROVAL]: {\n      actions: assign({ infiniteApproval: (_context, event) => event.infiniteApproval }),\n    },\n  },\n  states: {\n    [State.idle]: {\n      on: {\n        [Events.RUN]: [\n          { target: State.approve, cond: (context) => context.requireApproval },\n          { target: State.repay },\n        ],\n      },\n    },\n\n    [State.approve]: {\n      invoke: {\n        src: ServiceNames.approveSUSD,\n        onDone: {\n          target: State.repay,\n        },\n        onError: {\n          target: State.failed,\n          actions: assign({\n            error: (_context, event) => ({ error: event.data, step: FailedSteps.approve }),\n          }),\n        },\n      },\n    },\n    [State.repay]: {\n      invoke: {\n        src: ServiceNames.executeRepay,\n        onDone: {\n          target: State.success,\n        },\n        onError: {\n          target: State.failed,\n          actions: assign({\n            error: (_context, event) => ({ error: event.data, step: FailedSteps.repay }),\n          }),\n        },\n      },\n    },\n    [State.failed]: {\n      on: {\n        [Events.RETRY]: [\n          {\n            target: State.approve,\n            cond: (c) => c.error?.step === FailedSteps.approve,\n            actions: assign({ error: (_) => null }),\n          },\n\n          {\n            target: State.repay,\n            cond: (c) => c.error?.step === FailedSteps.repay,\n            actions: assign({ error: (_) => null }),\n          },\n        ],\n      },\n    },\n    [State.success]: {},\n  },\n});\n","import { Button, Divider, Text, useToast, Link, Flex, Skeleton } from '@chakra-ui/react';\nimport { Amount } from '@snx-v3/Amount';\nimport { ContractError } from '@snx-v3/ContractError';\nimport { parseUnits } from '@snx-v3/format';\nimport { isBaseAndromeda } from '@snx-v3/isBaseAndromeda';\nimport { ManagePositionContext } from '@snx-v3/ManagePositionContext';\nimport { Multistep } from '@snx-v3/Multistep';\nimport { useApprove } from '@snx-v3/useApprove';\nimport { useNetwork } from '@snx-v3/useBlockchain';\nimport { useCollateralType } from '@snx-v3/useCollateralTypes';\nimport { useContractErrorParser } from '@snx-v3/useContractErrorParser';\nimport { useCoreProxy } from '@snx-v3/useCoreProxy';\nimport { useGetUSDTokens } from '@snx-v3/useGetUSDTokens';\nimport { useParams } from '@snx-v3/useParams';\nimport { useRepay } from '@snx-v3/useRepay';\nimport { useRepayBaseAndromeda } from '@snx-v3/useRepayBaseAndromeda';\nimport { useSpotMarketProxy } from '@snx-v3/useSpotMarketProxy';\nimport { useTokenBalance } from '@snx-v3/useTokenBalance';\nimport { useSystemToken } from '@snx-v3/useSystemToken';\nimport Wei from '@synthetixio/wei';\nimport { useQueryClient } from '@tanstack/react-query';\nimport { useMachine } from '@xstate/react';\nimport { useCallback, useContext, useEffect } from 'react';\nimport type { StateFrom } from 'xstate';\nimport { Events, RepayMachine, ServiceNames, State } from './RepayMachine';\nimport { ArrowBackIcon } from '@chakra-ui/icons';\nimport { LiquidityPositionUpdated } from '../../ui/src/components/Manage/LiquidityPositionUpdated';\nimport { ZEROWEI } from '../../ui/src/utils/constants';\n\nexport const RepayModalUi: React.FC<{\n  onClose: () => void;\n  debtChange: Wei;\n  isOpen: boolean;\n  onSubmit: () => void;\n  state: StateFrom<typeof RepayMachine>;\n  setInfiniteApproval: (x: boolean) => void;\n}> = ({ onClose, isOpen, debtChange, state, onSubmit, setInfiniteApproval }) => {\n  const isProcessing = state.matches(State.approve) || state.matches(State.repay);\n  const { infiniteApproval, requireApproval, error } = state.context;\n  const { data: systemToken } = useSystemToken();\n\n  const { network } = useNetwork();\n  const isBase = isBaseAndromeda(network?.id, network?.preset);\n  const symbol = isBase ? ' USDC' : ` ${systemToken?.symbol}`;\n\n  if (isOpen) {\n    if (state.matches(State.success)) {\n      return (\n        <LiquidityPositionUpdated\n          onClose={onSubmit}\n          title=\"Debt successfully Updated\"\n          subline={\n            <>\n              Your <b>Debt</b> has been updated, read more about it in the{' '}\n              <Link\n                href=\"https://docs.synthetix.io/v/synthetix-v3-user-documentation\"\n                target=\"_blank\"\n                color=\"cyan.500\"\n              >\n                Synthetix V3 Documentation\n              </Link>\n            </>\n          }\n          alertText={\n            <>\n              <b>Debt</b> successfully Updated\n            </>\n          }\n        />\n      );\n    }\n\n    return (\n      <div>\n        <Text color=\"gray.50\" fontSize=\"20px\" fontWeight={700}>\n          <ArrowBackIcon cursor=\"pointer\" onClick={onClose} mr={2} />\n          Manage Debt\n        </Text>\n        <Divider my={4} />\n        <Multistep\n          step={1}\n          title={`Approve ${symbol} transfer`}\n          status={{\n            failed: error?.step === State.approve,\n            success: !requireApproval || state.matches(State.success),\n            loading: state.matches(State.approve) && !error,\n          }}\n          checkboxLabel={\n            requireApproval ? `Approve unlimited ${symbol} transfers to Synthetix.` : undefined\n          }\n          checkboxProps={{\n            isChecked: infiniteApproval,\n            onChange: (e) => setInfiniteApproval(e.target.checked),\n          }}\n        />\n        <Multistep\n          step={2}\n          title=\"Repay\"\n          subtitle={\n            <Text>\n              Repay <Amount value={debtChange.abs()} suffix={` ${symbol}`} />\n            </Text>\n          }\n          status={{\n            failed: error?.step === State.repay,\n            success: state.matches(State.success),\n            loading: state.matches(State.repay) && !error,\n          }}\n        />\n\n        <Button\n          isDisabled={isProcessing}\n          onClick={onSubmit}\n          width=\"100%\"\n          mt=\"6\"\n          data-testid=\"repay confirm button\"\n        >\n          {(() => {\n            switch (true) {\n              case Boolean(error):\n                return 'Retry';\n              case isProcessing:\n                return 'Processing...';\n              case state.matches(State.success):\n                return 'Continue';\n              default:\n                return 'Execute Transaction';\n            }\n          })()}\n        </Button>\n      </div>\n    );\n  }\n};\n\nexport const RepayModal: React.FC<{\n  onClose: () => void;\n  isOpen: boolean;\n  availableCollateral?: Wei;\n}> = ({ onClose, isOpen, availableCollateral }) => {\n  const { debtChange, setDebtChange } = useContext(ManagePositionContext);\n  const params = useParams();\n\n  const { network } = useNetwork();\n  const { data: usdTokens } = useGetUSDTokens();\n  const queryClient = useQueryClient();\n\n  const { data: collateralType } = useCollateralType(params.collateralSymbol);\n  const { data: systemToken } = useSystemToken();\n  const { data: balance } = useTokenBalance(systemToken?.address);\n\n  const { exec: execRepay, settle: settleRepay } = useRepay({\n    accountId: params.accountId,\n    poolId: params.poolId,\n    collateralTypeAddress: collateralType?.tokenAddress,\n    debtChange,\n    availableUSDCollateral: availableCollateral,\n    balance,\n  });\n\n  const { exec: execRepayBaseAndromeda, settle: settleRepayBaseAndromeda } = useRepayBaseAndromeda({\n    accountId: params.accountId,\n    poolId: params.poolId,\n    collateralTypeAddress: collateralType?.tokenAddress,\n    debtChange,\n    availableUSDCollateral: availableCollateral,\n  });\n\n  const toast = useToast({ isClosable: true, duration: 9000 });\n\n  const { data: CoreProxy } = useCoreProxy();\n  const { data: SpotProxy } = useSpotMarketProxy();\n\n  const errorParserCoreProxy = useContractErrorParser(CoreProxy);\n  const amountToDeposit = debtChange.abs().sub(availableCollateral || 0);\n\n  const collateralAddress = isBaseAndromeda(network?.id, network?.preset)\n    ? usdTokens?.USDC\n    : systemToken?.address;\n\n  const { approve, requireApproval } = useApprove({\n    contractAddress: collateralAddress,\n    amount: isBaseAndromeda(network?.id, network?.preset)\n      ? //Base USDC is 6 decimals\n        parseUnits(amountToDeposit.toString(), 6)\n      : amountToDeposit.toBN(),\n    spender: isBaseAndromeda(network?.id, network?.preset)\n      ? SpotProxy?.address\n      : CoreProxy?.address,\n  });\n\n  const [state, send] = useMachine(RepayMachine, {\n    services: {\n      [ServiceNames.approveSUSD]: async () => {\n        try {\n          toast({\n            title: `Approve ${systemToken?.symbol} for transfer`,\n            description: 'The next transaction will repay your debt.',\n            status: 'info',\n            variant: 'left-accent',\n          });\n\n          await approve(Boolean(state.context.infiniteApproval));\n        } catch (error: any) {\n          const contractError = errorParserCoreProxy(error);\n          if (contractError) {\n            console.error(new Error(contractError.name), contractError);\n          }\n          toast.closeAll();\n          toast({\n            title: 'Approval failed',\n            description: contractError ? (\n              <ContractError contractError={contractError} />\n            ) : (\n              'Please try again.'\n            ),\n            status: 'error',\n            variant: 'left-accent',\n          });\n          throw Error('Approve failed', { cause: error });\n        }\n      },\n\n      [ServiceNames.executeRepay]: async () => {\n        try {\n          toast.closeAll();\n          toast({ title: 'Repaying...', variant: 'left-accent' });\n\n          if (isBaseAndromeda(network?.id, network?.preset)) {\n            await execRepayBaseAndromeda();\n          } else {\n            await execRepay();\n          }\n\n          await Promise.all([\n            queryClient.invalidateQueries({\n              queryKey: [`${network?.id}-${network?.preset}`, 'TokenBalance'],\n            }),\n            queryClient.invalidateQueries({\n              queryKey: [`${network?.id}-${network?.preset}`, 'Allowance'],\n            }),\n            queryClient.invalidateQueries({\n              queryKey: [`${network?.id}-${network?.preset}`, 'LiquidityPosition'],\n            }),\n          ]);\n          setDebtChange(ZEROWEI);\n\n          toast.closeAll();\n          toast({\n            title: 'Success',\n            description: 'Your debt has been repaid.',\n            status: 'success',\n            duration: 5000,\n            variant: 'left-accent',\n          });\n        } catch (error: any) {\n          const contractError = errorParserCoreProxy(error);\n          if (contractError) {\n            console.error(new Error(contractError.name), contractError);\n          }\n          toast({\n            title: 'Could not complete repaying',\n            description: contractError ? (\n              <ContractError contractError={contractError} />\n            ) : (\n              'Please try again.'\n            ),\n            status: 'error',\n            variant: 'left-accent',\n          });\n          throw Error('Repay failed', { cause: error });\n        }\n      },\n    },\n  });\n  const needToDeposit = amountToDeposit.gt(0);\n\n  useEffect(() => {\n    send(Events.SET_REQUIRE_APPROVAL, { requireApproval: requireApproval && needToDeposit });\n  }, [needToDeposit, requireApproval, send]);\n\n  const onSubmit = useCallback(async () => {\n    if (state.matches(State.success)) {\n      send(Events.RESET);\n      onClose();\n      return;\n    }\n    if (state.context.error) {\n      send(Events.RETRY);\n      return;\n    }\n    send(Events.RUN);\n  }, [onClose, send, state]);\n\n  if (!params.poolId || !params.accountId || !collateralType)\n    return (\n      <Flex gap={4} flexDirection=\"column\">\n        <Skeleton maxW=\"232px\" width=\"100%\" height=\"20px\" />\n        <Divider my={4} />\n        <Skeleton width=\"100%\" height=\"20px\" />\n        <Skeleton width=\"100%\" height=\"20px\" />\n      </Flex>\n    );\n\n  return (\n    <RepayModalUi\n      state={state}\n      onSubmit={onSubmit}\n      debtChange={debtChange}\n      setInfiniteApproval={(infiniteApproval) => {\n        send(Events.SET_INFINITE_APPROVAL, { infiniteApproval });\n      }}\n      onClose={() => {\n        settleRepay();\n        settleRepayBaseAndromeda();\n        onClose();\n      }}\n      isOpen={isOpen}\n    />\n  );\n};\n","import { useReducer } from 'react';\nimport { useCoreProxy } from '@snx-v3/useCoreProxy';\nimport { formatGasPriceForTransaction } from '@snx-v3/useGasOptions';\nimport { useMutation } from '@tanstack/react-query';\nimport { useNetwork, useProvider, useSigner } from '@snx-v3/useBlockchain';\nimport { initialState, reducer } from '@snx-v3/txnReducer';\nimport Wei from '@synthetixio/wei';\nimport { BigNumber, ethers } from 'ethers';\nimport { getGasPrice } from '@snx-v3/useGasPrice';\nimport { useGasSpeed } from '@snx-v3/useGasSpeed';\nimport { useSystemToken } from '@snx-v3/useSystemToken';\nimport { notNil } from '@snx-v3/tsHelpers';\nimport { withERC7412 } from '@snx-v3/withERC7412';\nimport { useSpotMarketProxy } from '../useSpotMarketProxy';\nimport { USDC_BASE_MARKET } from '@snx-v3/isBaseAndromeda';\nimport { parseUnits } from '@snx-v3/format';\nimport { approveAbi } from '@snx-v3/useApprove';\nimport { useCollateralPriceUpdates } from '../useCollateralPriceUpdates';\nimport { useGetUSDTokens } from '@snx-v3/useGetUSDTokens';\n\nexport const useRepayBaseAndromeda = ({\n  accountId,\n  poolId,\n  collateralTypeAddress,\n  debtChange,\n  availableUSDCollateral,\n}: {\n  accountId?: string;\n  poolId?: string;\n  collateralTypeAddress?: string;\n  availableUSDCollateral?: Wei;\n  debtChange: Wei;\n}) => {\n  const [txnState, dispatch] = useReducer(reducer, initialState);\n  const { data: CoreProxy } = useCoreProxy();\n  const { data: systemToken } = useSystemToken();\n  const { data: SpotMarketProxy } = useSpotMarketProxy();\n  const { data: priceUpdateTx } = useCollateralPriceUpdates();\n  const { data: usdTokens } = useGetUSDTokens();\n\n  const signer = useSigner();\n  const { network } = useNetwork();\n  const { gasSpeed } = useGasSpeed();\n  const provider = useProvider();\n\n  const mutation = useMutation({\n    mutationFn: async () => {\n      if (!signer || !network || !provider) throw new Error('No signer or network');\n\n      if (\n        !(\n          CoreProxy &&\n          poolId &&\n          accountId &&\n          collateralTypeAddress &&\n          systemToken &&\n          SpotMarketProxy &&\n          usdTokens?.sUSD\n        )\n      ) {\n        return;\n      }\n\n      if (!availableUSDCollateral) return;\n      if (debtChange.eq(0)) return;\n      const debtChangeAbs = debtChange.abs();\n      const amountToDeposit = debtChangeAbs.sub(availableUSDCollateral);\n      const usdcAmount = amountToDeposit.gt(0)\n        ? parseUnits(amountToDeposit.toString(), 6)\n        : BigNumber.from(0);\n\n      try {\n        dispatch({ type: 'prompting' });\n\n        // USDC => sUSDC\n        const wrap = amountToDeposit.gt(0)\n          ? SpotMarketProxy.populateTransaction.wrap(USDC_BASE_MARKET, usdcAmount, 0)\n          : undefined;\n\n        const sUSDC_ADDRESS = usdTokens?.sUSD;\n        const sUSDC_Contract = new ethers.Contract(sUSDC_ADDRESS, approveAbi, signer);\n\n        const sUSDC_Approval = amountToDeposit.gt(0)\n          ? sUSDC_Contract.populateTransaction.approve(\n              SpotMarketProxy.address,\n              amountToDeposit.toBN()\n            )\n          : undefined;\n\n        // sell sUSDC => sUSD\n        const sell = amountToDeposit.gt(0)\n          ? SpotMarketProxy.populateTransaction.sell(\n              USDC_BASE_MARKET,\n              amountToDeposit.toBN(),\n              0,\n              ethers.constants.AddressZero\n            )\n          : undefined;\n\n        // approve sUSD to Core\n        const sUSD_Contract = new ethers.Contract(systemToken.address, approveAbi, signer);\n\n        const sUSD_Approval = amountToDeposit.gt(0)\n          ? sUSD_Contract.populateTransaction.approve(CoreProxy.address, amountToDeposit.toBN())\n          : undefined;\n\n        // Only deposit if user doesn't have enough sUSD collateral\n        const deposit = amountToDeposit.lte(0)\n          ? undefined\n          : CoreProxy.populateTransaction.deposit(\n              BigNumber.from(accountId),\n              systemToken.address,\n              amountToDeposit.toBN() // only deposit what's needed\n            );\n\n        const burn = CoreProxy.populateTransaction.burnUsd(\n          BigNumber.from(accountId),\n          BigNumber.from(poolId),\n          collateralTypeAddress,\n          debtChangeAbs.toBN()\n        );\n\n        const callsPromise = Promise.all(\n          [wrap, sUSDC_Approval, sell, sUSD_Approval, deposit, burn].filter(notNil)\n        );\n\n        const [calls, gasPrices] = await Promise.all([callsPromise, getGasPrice({ provider })]);\n        if (priceUpdateTx) {\n          calls.push(priceUpdateTx as any);\n        }\n\n        const walletAddress = await signer.getAddress();\n        const erc7412Tx = await withERC7412(network, calls, 'useRepay', walletAddress);\n\n        const gasOptionsForTransaction = formatGasPriceForTransaction({\n          gasLimit: erc7412Tx.gasLimit,\n          gasPrices,\n          gasSpeed,\n        });\n\n        const txn = await signer.sendTransaction({ ...erc7412Tx, ...gasOptionsForTransaction });\n        dispatch({ type: 'pending', payload: { txnHash: txn.hash } });\n\n        await txn.wait();\n        dispatch({ type: 'success' });\n      } catch (error: any) {\n        dispatch({ type: 'error', payload: { error } });\n        throw error;\n      }\n    },\n  });\n  return {\n    mutation,\n    txnState,\n    settle: () => dispatch({ type: 'settled' }),\n    isLoading: mutation.isPending,\n    exec: mutation.mutateAsync,\n  };\n};\n","import { RepayModal } from './RepayModal';\nexport * from './RepayModal';\nexport default RepayModal;\n"],"names":["Events","State","FailedSteps","ServiceNames","initialContext","error","requireApproval","infiniteApproval","RepayMachine","createMachine","id","initial","predictableActionArguments","context","on","target","actions","assign","_","_context","event","states","cond","invoke","src","onDone","onError","data","step","approve","repay","c","RepayModalUi","onClose","isOpen","debtChange","state","onSubmit","setInfiniteApproval","isProcessing","matches","systemToken","useSystemToken","network","useNetwork","symbol","isBaseAndromeda","preset","_jsx","LiquidityPositionUpdated","title","subline","_jsxs","_Fragment","children","Link","href","color","alertText","Text","fontSize","fontWeight","ArrowBackIcon","cursor","onClick","mr","Divider","my","Multistep","status","failed","success","loading","checkboxLabel","undefined","checkboxProps","isChecked","onChange","e","checked","subtitle","Amount","value","abs","suffix","Button","isDisabled","width","mt","Boolean","RepayModal","availableCollateral","setDebtChange","useContext","ManagePositionContext","params","useParams","usdTokens","useGetUSDTokens","queryClient","useQueryClient","collateralType","useCollateralType","collateralSymbol","balance","useTokenBalance","address","exec","execRepay","settle","settleRepay","useRepay","accountId","poolId","collateralTypeAddress","tokenAddress","availableUSDCollateral","execRepayBaseAndromeda","settleRepayBaseAndromeda","useRepayBaseAndromeda","txnState","dispatch","useReducer","reducer","initialState","CoreProxy","useCoreProxy","SpotMarketProxy","useSpotMarketProxy","priceUpdateTx","useCollateralPriceUpdates","signer","useSigner","gasSpeed","useGasSpeed","provider","useProvider","mutation","useMutation","mutationFn","async","Error","sUSD","eq","debtChangeAbs","amountToDeposit","sub","usdcAmount","gt","parseUnits","toString","BigNumber","from","type","wrap","populateTransaction","USDC_BASE_MARKET","sUSDC_ADDRESS","sUSDC_Contract","ethers","approveAbi","sUSDC_Approval","toBN","sell","sUSD_Contract","sUSD_Approval","deposit","lte","burn","burnUsd","callsPromise","Promise","all","filter","notNil","calls","gasPrices","getGasPrice","push","walletAddress","getAddress","erc7412Tx","withERC7412","gasOptionsForTransaction","formatGasPriceForTransaction","gasLimit","txn","sendTransaction","payload","txnHash","hash","wait","isLoading","isPending","mutateAsync","toast","useToast","isClosable","duration","SpotProxy","errorParserCoreProxy","useContractErrorParser","collateralAddress","USDC","useApprove","contractAddress","amount","spender","send","useMachine","services","description","variant","contractError","console","name","closeAll","ContractError","cause","invalidateQueries","queryKey","ZEROWEI","needToDeposit","useEffect","useCallback","Flex","gap","flexDirection","Skeleton","maxW","height"],"sourceRoot":""}