"use strict";(globalThis.webpackChunk_snx_v3_liquidity=globalThis.webpackChunk_snx_v3_liquidity||[]).push([[2899],{99581:(e,t,r)=>{r.d(t,{M:()=>d});var a=r(2784),n=r(84626),o=r(87651),s=r(59176),i=r(65068),l=r(52322);const c="true"===window?.localStorage?.CONTRACT_ERROR_OPEN;function d({contractError:e}){const[t,r]=a.useState(c);return(0,l.jsxs)(l.Fragment,{children:[t?null:(0,l.jsx)(n.z,{variant:"link",onClick:()=>r(!0),color:"inherit",fontWeight:"normal",fontStyle:"italic",children:"details..."}),(0,l.jsxs)(o.U,{in:t,animateOpacity:!0,children:[(0,l.jsx)(s.x,{fontStyle:"italic",fontSize:"0.8em",children:e.name}),(0,l.jsx)(s.x,{whiteSpace:"pre",fontSize:"0.8em",fontStyle:"italic",pl:"0.5em",children:Object.entries(e.args).map((([e,t])=>`${e}: ${t instanceof Date?(0,i.Z)(t,"yyyy-MM-dd HH:mm:ss"):t}`)).join("\n")})]})]})}},25042:(e,t,r)=>{r.d(t,{nQ:()=>l,Tw:()=>c,P0:()=>y});var a=r(38035),n=r(81540),o=r(28535),s=r(21112),i=r(52322);const l=(0,s.I)({viewBox:"0 0 14 14",path:(0,i.jsx)("g",{fill:"currentColor",children:(0,i.jsx)("polygon",{points:"5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"})})}),c=(0,s.I)({d:"M.439,21.44a1.5,1.5,0,0,0,2.122,2.121L11.823,14.3a.25.25,0,0,1,.354,0l9.262,9.263a1.5,1.5,0,1,0,2.122-2.121L14.3,12.177a.25.25,0,0,1,0-.354l9.263-9.262A1.5,1.5,0,0,0,21.439.44L12.177,9.7a.25.25,0,0,1-.354,0L2.561.44A1.5,1.5,0,0,0,.439,2.561L9.7,11.823a.25.25,0,0,1,0,.354Z"});function d({status:e,children:t}){switch(!0){case e.failed:return(0,i.jsx)(c,{color:"white"});case e.success:return(0,i.jsx)(l,{color:"white"});case e.loading:return(0,i.jsx)(n.$,{color:"white",width:6,height:6});case e.disabled:default:return(0,i.jsx)(o.xu,{__css:{display:"inline",fontWeight:"medium",textAlign:"center",fontSize:"md"},children:t})}}function p(e){switch(!0){case e.failed:return"red.700";case e.disabled:case e.loading:return"gray.700";case e.success:return"green.700";default:return"gray.700"}}function u({status:e,children:t}){return(0,i.jsx)(a.k,{width:10,height:10,minWidth:10,minHeight:10,justifyContent:"center",alignItems:"center",bg:p(e),rounded:"full",transitionProperty:"background",transitionDuration:"normal",children:(0,i.jsx)(d,{status:e,children:t})})}var h=r(78876),f=r(59176);function g({children:e,...t}){return(0,i.jsx)(a.k,{mt:"0.5",children:(0,i.jsx)(h.X,{size:"sm",...t,children:(0,i.jsx)(o.xu,{fontSize:"xs",opacity:"0.66",children:e})})})}function y({step:e,title:t,subtitle:r,checkboxLabel:n,checkboxProps:o,status:s,children:l}){return(0,i.jsxs)(a.k,{position:"relative",alignItems:"center",gap:4,rounded:"lg",mt:"4",p:"4",border:"2px solid",transitionProperty:"border-color",transitionDuration:"normal",borderColor:p(s),children:[(0,i.jsx)(u,{status:s,children:e}),(0,i.jsxs)(a.k,{direction:"column",children:[(0,i.jsx)(f.x,{"data-cy":`multistep-${e}`,children:t}),r?(0,i.jsx)(f.x,{as:"div",fontSize:"xs",opacity:"0.66",children:r}):null,n?(0,i.jsx)(g,{...o,children:n}):null,l]})]})}},2899:(e,t,r)=>{r.r(t),r.d(t,{RepayModal:()=>le,RepayModalUi:()=>ie,default:()=>ce});var a=r(66901),n=r(26468),o=r(19433),s=r(54326),i=r(2338),l=r(97217),c=r(59176),d=r(84626),p=r(70065),u=r(45071),h=r(99581),f=r(96596),g=r(77528),y=r(13797),m=r(25042),x=r(42383),v=r(76885),b=r(19299),w=r(97721),A=r(40109),S=r(34367),j=r(89536),C=r(2784),k=r(99),I=r(28145),T=r(17716),E=r(10528),P=r(35834),R=r(95772),D=r(75072),O=r(37330),N=r(860),L=r(42614),U=r(95522);var $=r(50986),q=r(51906),_=r(28783),z=r(11838);var M=r(55576),B=r(97737),F=r(9875),H=r(97386);const Y="SET_REQUIRE_APPROVAL",Q="SET_INFINITE_APPROVAL",K="RETRY",W="RUN",X="RESET",Z="idle",V="approve",G="repay",J="failed",ee="success",te={[V]:V,[G]:G},re="approveSUSD",ae="executeRepay",ne={error:null,requireApproval:!1,infiniteApproval:!1},oe=(0,F.C)({id:"RepayMachine",initial:Z,predictableActionArguments:!0,context:ne,on:{[W]:{target:G,actions:(0,H.f0)({error:e=>ne.error,requireApproval:e=>ne.requireApproval,infiniteApproval:e=>ne.infiniteApproval})},[Y]:{actions:(0,H.f0)({requireApproval:(e,t)=>t.requireApproval})},[Q]:{actions:(0,H.f0)({infiniteApproval:(e,t)=>t.infiniteApproval})}},states:{[Z]:{on:{[W]:[{target:V,cond:e=>e.requireApproval},{target:G}]}},[V]:{invoke:{src:re,onDone:{target:G},onError:{target:J,actions:(0,H.f0)({error:(e,t)=>({error:t.data,step:te.approve})})}}},[G]:{invoke:{src:ae,onDone:{target:ee},onError:{target:J,actions:(0,H.f0)({error:(e,t)=>({error:t.data,step:te.repay})})}}},[J]:{on:{[K]:[{target:V,cond:e=>e.error?.step===te.approve,actions:(0,H.f0)({error:e=>null})},{target:G,cond:e=>e.error?.step===te.repay,actions:(0,H.f0)({error:e=>null})}]}},[ee]:{}}});var se=r(52322);const ie=({onClose:e,isOpen:t,debtChange:r,state:p,onSubmit:h,setInfiniteApproval:f})=>{const g=p.matches(V)||p.matches(G),{infiniteApproval:y,requireApproval:x,error:v}=p.context;return(0,se.jsxs)(a.u_,{size:"lg",isOpen:t,onClose:e,closeOnOverlayClick:!1,children:[(0,se.jsx)(n.Z,{}),(0,se.jsxs)(o.h,{bg:"black",color:"white","data-testid":"repay modal",children:[(0,se.jsx)(s.x,{children:"Complete this action"}),(0,se.jsx)(i.o,{}),(0,se.jsxs)(l.f,{children:[(0,se.jsx)(m.P0,{step:1,title:"Approve sUSD transfer",status:{failed:v?.step===V,success:!x||p.matches(ee),loading:p.matches(V)&&!v},checkboxLabel:"Approve unlimited sUSD transfers to Synthetix.",checkboxProps:{isChecked:y,onChange:e=>f(e.target.checked)}}),(0,se.jsx)(m.P0,{step:2,title:"Repay",subtitle:(0,se.jsxs)(c.x,{children:["Repay ",(0,se.jsx)(u.$,{value:r.abs(),suffix:" sUSD"})]}),status:{failed:v?.step===G,success:p.matches(ee),loading:p.matches(G)&&!v}}),(0,se.jsx)(d.z,{isDisabled:g,onClick:h,width:"100%",my:"4","data-testid":"repay confirm button",children:(()=>{switch(!0){case Boolean(v):return"Retry";case g:return"Processing...";case p.matches(ee):return"Done";default:return"Start"}})()})]})]})]})},le=({onClose:e,isOpen:t,availableCollateral:r})=>{const{debtChange:a}=(0,C.useContext)(y.n),n=(0,j.UO)(),{network:o}=(0,v.LN)(),{data:s}=(0,S.X)(),i=(0,I.useQueryClient)(),{data:l}=(0,D.a)(),{data:c}=(0,b.t)(n.collateralSymbol),{data:d}=(0,M.mM)(l?.address),{exec:u,settle:m}=(({accountId:e,poolId:t,collateralTypeAddress:r,debtChange:a,balance:n,availableUSDCollateral:o})=>{const[s,i]=(0,C.useReducer)(T.I,T.E),{data:l}=(0,A.a)(),{data:c}=(0,D.a)(),{data:d}=(0,L.L)(),p=(0,v.mx)(),{network:u}=(0,v.LN)(),{gasSpeed:h}=(0,R.jU)(),f=(0,v.yL)(),g=(0,I.useMutation)({mutationFn:async()=>{if(!p||!u||!f)throw new Error("No signer or network");if(!(l&&t&&e&&r&&c&&d))return;if(!n)return;if(!o)return;if(a.eq(0))return;const s=a.abs(),g=s.sub(o);try{i({type:"prompting"});const a=g.lte(0)?void 0:l.populateTransaction.deposit(E.O$.from(e),c.address,g.toBN()),n=l.populateTransaction.burnUsd(E.O$.from(e),E.O$.from(t),r,s.toBN()),o=Promise.all([a,n].filter(O._)),y=await p.getAddress(),m=(0,U.$)(d,u.isTestnet).then((e=>(0,U.x)(y,d,e))),[x,v,b]=await Promise.all([o,(0,P.o)({provider:f}),m]),w=b.concat(x),A=await(0,N.dI)(u,w,"useRepay",l.interface),S=(0,k.F)({gasLimit:A.gasLimit,gasPrices:v,gasSpeed:h}),j=await p.sendTransaction({...A,...S});i({type:"pending",payload:{txnHash:j.hash}}),await j.wait(),i({type:"success"})}catch(e){throw i({type:"error",payload:{error:e}}),e}}});return{mutation:g,txnState:s,settle:()=>i({type:"settled"}),isLoading:g.isPending,exec:g.mutateAsync}})({accountId:n.accountId,poolId:n.poolId,collateralTypeAddress:c?.tokenAddress,debtChange:a,availableUSDCollateral:r,balance:d}),{exec:F,settle:H}=(({accountId:e,poolId:t,collateralTypeAddress:r,debtChange:a,availableUSDCollateral:n})=>{const[o,s]=(0,C.useReducer)(T.I,T.E),{data:i}=(0,A.a)(),{data:l}=(0,D.a)(),{data:c}=(0,_.b)(),{data:d}=(0,z.Y)(),{data:p}=(0,S.X)(),u=(0,v.mx)(),{network:h}=(0,v.LN)(),{gasSpeed:y}=(0,R.jU)(),m=(0,v.yL)(),b=(0,I.useMutation)({mutationFn:async()=>{if(!u||!h||!m)throw new Error("No signer or network");if(!(i&&t&&e&&r&&l&&c&&p?.sUSD))return;if(!n)return;if(a.eq(0))return;const o=a.abs(),v=o.sub(n),b=v.gt(0)?(0,f.vz)(v.toString(),6):E.O$.from(0);try{s({type:"prompting"});const a=v.gt(0)?c.populateTransaction.wrap(g.Ds,b,0):void 0,n=p?.sUSD,f=new $.CH(n,x.P,u),w=v.gt(0)?f.populateTransaction.approve(c.address,v.toBN()):void 0,A=v.gt(0)?c.populateTransaction.sell(g.Ds,v.toBN(),0,q.d):void 0,S=new $.CH(l.address,x.P,u),j=v.gt(0)?S.populateTransaction.approve(i.address,v.toBN()):void 0,C=v.lte(0)?void 0:i.populateTransaction.deposit(E.O$.from(e),l.address,v.toBN()),I=i.populateTransaction.burnUsd(E.O$.from(e),E.O$.from(t),r,o.toBN()),T=Promise.all([a,w,A,j,C,I].filter(O._)),[R,D]=await Promise.all([T,(0,P.o)({provider:m})]);d&&R.push(d);const L=await(0,N.dI)(h,R,"useRepay",i.interface),U=(0,k.F)({gasLimit:L.gasLimit,gasPrices:D,gasSpeed:y}),_=await u.sendTransaction({...L,...U});s({type:"pending",payload:{txnHash:_.hash}}),await _.wait(),s({type:"success"})}catch(e){throw s({type:"error",payload:{error:e}}),e}}});return{mutation:b,txnState:o,settle:()=>s({type:"settled"}),isLoading:b.isPending,exec:b.mutateAsync}})({accountId:n.accountId,poolId:n.poolId,collateralTypeAddress:c?.tokenAddress,debtChange:a,availableUSDCollateral:r}),Z=(0,p.p)({isClosable:!0,duration:9e3}),{data:V}=(0,A.a)(),{data:G}=(0,_.b)(),J=(0,w.o)(V),te=a.abs().sub(r||0),ne=(0,g.Yz)(o?.id,o?.preset)?s?.USDC:l?.address,{approve:le,requireApproval:ce}=(0,x.y)({contractAddress:ne,amount:(0,g.Yz)(o?.id,o?.preset)?(0,f.vz)(te.toString(),6):te.toBN(),spender:(0,g.Yz)(o?.id,o?.preset)?G?.address:V?.address}),[de,pe]=(0,B.e)(oe,{services:{[re]:async()=>{try{Z({title:"Approve sUSD for transfer",description:"The next transaction will repay your debt.",status:"info"}),await le(Boolean(de.context.infiniteApproval))}catch(e){const t=J(e);throw t&&console.error(new Error(t.name),t),Z.closeAll(),Z({title:"Approval failed",description:t?(0,se.jsx)(h.M,{contractError:t}):"Please try again.",status:"error"}),Error("Approve failed",{cause:e})}},[ae]:async()=>{try{Z.closeAll(),Z({title:"Repaying..."}),(0,g.Yz)(o?.id,o?.preset)?await F():await u(),await Promise.all([i.invalidateQueries({queryKey:[`${o?.id}-${o?.preset}`,"TokenBalance"]}),i.invalidateQueries({queryKey:[`${o?.id}-${o?.preset}`,"Allowance"]}),i.invalidateQueries({queryKey:[`${o?.id}-${o?.preset}`,"LiquidityPosition"]})]),Z.closeAll(),Z({title:"Success",description:"Your debt has been repaid.",status:"success",duration:5e3})}catch(e){const t=J(e);throw t&&console.error(new Error(t.name),t),Z({title:"Could not complete repaying",description:t?(0,se.jsx)(h.M,{contractError:t}):"Please try again.",status:"error"}),Error("Repay failed",{cause:e})}}}}),ue=te.gt(0);(0,C.useEffect)((()=>{pe(Y,{requireApproval:ce&&ue})}),[ue,ce,pe]);const he=(0,C.useCallback)((async()=>{if(de.matches(ee))return pe(X),void e();de.context.error?pe(K):pe(W)}),[e,pe,de]);return n.poolId&&n.accountId&&c?(0,se.jsx)(ie,{state:de,onSubmit:he,debtChange:a,setInfiniteApproval:e=>{pe(Q,{infiniteApproval:e})},onClose:()=>{m(),H(),e()},isOpen:t}):null},ce=le},97721:(e,t,r)=>{r.d(t,{o:()=>c});r(5875),r(50509),r(38728),r(64810),r(43419),r(32825),r(16093),r(77829),r(60253),r(49225),r(79941),r(57265),r(25888),r(15840),r(37610),r(13351);var a=r(79155),n=r(50986),o=r(10528),s=r(49494),i=r(2784),l=r(860);function c(e){return(0,i.useCallback)((t=>{if(e)try{const r=t?.error?.data?.data||t?.error?.error?.data;if(!r)return void console.error({error:t});const i=e.interface.format(a.pc.full),c=new n.CH(e.address,Array.from(new Set(i.concat(l.IN).concat(["error CannotSelfApprove(address addr)","error InvalidTransferRecipient(address addr)","error InvalidOwner(address addr)","error TokenDoesNotExist(uint256 id)","error TokenAlreadyMinted(uint256 id)"]))),e.signer||e.provider).interface.parseError(r),d=Object.fromEntries(Object.entries(c.args).filter((([e])=>`${parseInt(e)}`!==e)).map((([e,t])=>{if(t instanceof o.O$){const r=parseFloat(s.dF(t.toString()));return r>.001?[e,r]:t.toNumber()>new Date(2e3,1,1).getTime()/1e3&&t.toNumber()<new Date(2100,1,1).getTime()/1e3?[e,new Date(1e3*t.toNumber())]:[e,parseFloat(t.toString())]}return[e,t]})));return{data:r,name:c.name,signature:c.signature,args:d}}catch(e){return void console.error(e)}}),[e])}}}]);
//# sourceMappingURL=2899.475899b5.js.map