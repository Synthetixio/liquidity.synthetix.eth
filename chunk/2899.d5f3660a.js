"use strict";(globalThis.webpackChunk_snx_v3_liquidity=globalThis.webpackChunk_snx_v3_liquidity||[]).push([[2899],{99581:(e,t,r)=>{r.d(t,{M:()=>d});var a=r(2784),n=r(84626),o=r(87651),s=r(59176),i=r(65068),l=r(52322);const c="true"===window?.localStorage?.CONTRACT_ERROR_OPEN;function d({contractError:e}){const[t,r]=a.useState(c);return(0,l.jsxs)(l.Fragment,{children:[t?null:(0,l.jsx)(n.z,{variant:"link",onClick:()=>r(!0),color:"inherit",fontWeight:"normal",fontStyle:"italic",children:"details..."}),(0,l.jsxs)(o.U,{in:t,animateOpacity:!0,children:[(0,l.jsx)(s.x,{fontStyle:"italic",fontSize:"0.8em",children:e.name}),(0,l.jsx)(s.x,{whiteSpace:"pre",fontSize:"0.8em",fontStyle:"italic",pl:"0.5em",children:Object.entries(e.args).map((([e,t])=>`${e}: ${t instanceof Date?(0,i.Z)(t,"yyyy-MM-dd HH:mm:ss"):t}`)).join("\n")})]})]})}},25042:(e,t,r)=>{r.d(t,{nQ:()=>l,Tw:()=>c,P0:()=>y});var a=r(38035),n=r(81540),o=r(28535),s=r(21112),i=r(52322);const l=(0,s.I)({viewBox:"0 0 14 14",path:(0,i.jsx)("g",{fill:"currentColor",children:(0,i.jsx)("polygon",{points:"5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"})})}),c=(0,s.I)({d:"M.439,21.44a1.5,1.5,0,0,0,2.122,2.121L11.823,14.3a.25.25,0,0,1,.354,0l9.262,9.263a1.5,1.5,0,1,0,2.122-2.121L14.3,12.177a.25.25,0,0,1,0-.354l9.263-9.262A1.5,1.5,0,0,0,21.439.44L12.177,9.7a.25.25,0,0,1-.354,0L2.561.44A1.5,1.5,0,0,0,.439,2.561L9.7,11.823a.25.25,0,0,1,0,.354Z"});function d({status:e,children:t}){switch(!0){case e.failed:return(0,i.jsx)(c,{color:"white"});case e.success:return(0,i.jsx)(l,{color:"white"});case e.loading:return(0,i.jsx)(n.$,{color:"white",width:6,height:6});case e.disabled:default:return(0,i.jsx)(o.xu,{__css:{display:"inline",fontWeight:"medium",textAlign:"center",fontSize:"md"},children:t})}}function p(e){switch(!0){case e.failed:return"red.700";case e.disabled:case e.loading:return"gray.700";case e.success:return"green.700";default:return"gray.700"}}function u({status:e,children:t}){return(0,i.jsx)(a.k,{width:10,height:10,minWidth:10,minHeight:10,justifyContent:"center",alignItems:"center",bg:p(e),rounded:"full",transitionProperty:"background",transitionDuration:"normal",children:(0,i.jsx)(d,{status:e,children:t})})}var h=r(78876),f=r(59176);function g({children:e,...t}){return(0,i.jsx)(a.k,{mt:"0.5",children:(0,i.jsx)(h.X,{size:"sm",...t,children:(0,i.jsx)(o.xu,{fontSize:"xs",opacity:"0.66",children:e})})})}function y({step:e,title:t,subtitle:r,checkboxLabel:n,checkboxProps:o,status:s,children:l}){return(0,i.jsxs)(a.k,{position:"relative",alignItems:"center",gap:4,rounded:"lg",mt:"4",p:"4",border:"2px solid",transitionProperty:"border-color",transitionDuration:"normal",borderColor:p(s),children:[(0,i.jsx)(u,{status:s,children:e}),(0,i.jsxs)(a.k,{direction:"column",children:[(0,i.jsx)(f.x,{"data-cy":`multistep-${e}`,children:t}),r?(0,i.jsx)(f.x,{as:"div",fontSize:"xs",opacity:"0.66",children:r}):null,n?(0,i.jsx)(g,{...o,children:n}):null,l]})]})}},2899:(e,t,r)=>{r.r(t),r.d(t,{RepayModal:()=>le,RepayModalUi:()=>ie,default:()=>ce});var a=r(66901),n=r(26468),o=r(19433),s=r(54326),i=r(2338),l=r(97217),c=r(59176),d=r(84626),p=r(70065),u=r(45071),h=r(25042),f=r(2784),g=r(99581),y=r(40109),m=r(99),x=r(28145),v=r(76885),b=r(17716),w=r(10528),A=r(35834),S=r(95772),j=r(63478),C=r(37330),k=r(860),I=r(51686),T=r(95522);var E=r(89536),P=r(13797),R=r(19299),D=r(97721),O=r(42383),N=r(55576),L=r(97737),U=r(9875),$=r(97386);const q="SET_REQUIRE_APPROVAL",_="SET_INFINITE_APPROVAL",z="RETRY",M="RUN",B="RESET",F="idle",H="approve",Y="repay",Q="failed",K="success",W={[H]:H,[Y]:Y},X="approveSUSD",Z="executeRepay",V={error:null,requireApproval:!1,infiniteApproval:!1},G=(0,U.C)({id:"RepayMachine",initial:F,predictableActionArguments:!0,context:V,on:{[M]:{target:Y,actions:(0,$.f0)({error:e=>V.error,requireApproval:e=>V.requireApproval,infiniteApproval:e=>V.infiniteApproval})},[q]:{actions:(0,$.f0)({requireApproval:(e,t)=>t.requireApproval})},[_]:{actions:(0,$.f0)({infiniteApproval:(e,t)=>t.infiniteApproval})}},states:{[F]:{on:{[M]:[{target:H,cond:e=>e.requireApproval},{target:Y}]}},[H]:{invoke:{src:X,onDone:{target:Y},onError:{target:Q,actions:(0,$.f0)({error:(e,t)=>({error:t.data,step:W.approve})})}}},[Y]:{invoke:{src:Z,onDone:{target:K},onError:{target:Q,actions:(0,$.f0)({error:(e,t)=>({error:t.data,step:W.repay})})}}},[Q]:{on:{[z]:[{target:H,cond:e=>e.error?.step===W.approve,actions:(0,$.f0)({error:e=>null})},{target:Y,cond:e=>e.error?.step===W.repay,actions:(0,$.f0)({error:e=>null})}]}},[K]:{}}});var J=r(50986),ee=r(51906),te=r(81666),re=r(77528),ae=r(96596),ne=r(11838),oe=r(34367);var se=r(52322);const ie=({onClose:e,isOpen:t,debtChange:r,state:p,onSubmit:f,setInfiniteApproval:g})=>{const y=p.matches(H)||p.matches(Y),{infiniteApproval:m,requireApproval:x,error:v}=p.context;return(0,se.jsxs)(a.u_,{size:"lg",isOpen:t,onClose:e,closeOnOverlayClick:!1,children:[(0,se.jsx)(n.Z,{}),(0,se.jsxs)(o.h,{bg:"black",color:"white","data-testid":"repay modal",children:[(0,se.jsx)(s.x,{children:"Complete this action"}),(0,se.jsx)(i.o,{}),(0,se.jsxs)(l.f,{children:[(0,se.jsx)(h.P0,{step:1,title:"Approve sUSD transfer",status:{failed:v?.step===H,success:!x||p.matches(K),loading:p.matches(H)&&!v},checkboxLabel:"Approve unlimited sUSD transfers to Synthetix.",checkboxProps:{isChecked:m,onChange:e=>g(e.target.checked)}}),(0,se.jsx)(h.P0,{step:2,title:"Repay",subtitle:(0,se.jsxs)(c.x,{children:["Repay ",(0,se.jsx)(u.$,{value:r.abs(),suffix:" sUSD"})]}),status:{failed:v?.step===Y,success:p.matches(K),loading:p.matches(Y)&&!v}}),(0,se.jsx)(d.z,{isDisabled:y,onClick:f,width:"100%",my:"4","data-testid":"repay confirm button",children:(()=>{switch(!0){case Boolean(v):return"Retry";case y:return"Processing...";case p.matches(K):return"Done";default:return"Start"}})()})]})]})]})},le=({onClose:e,isOpen:t,availableCollateral:r})=>{const{debtChange:a}=(0,f.useContext)(P.n),n=(0,E.UO)(),{network:o}=(0,v.LN)(),{data:s}=(0,oe.X)(),i=(0,x.useQueryClient)(),{data:l}=(0,j.a)(),{data:c}=(0,R.t)(n.collateralSymbol),{data:d}=(0,N.mM)(l?.address),{exec:u,settle:h}=(({accountId:e,poolId:t,collateralTypeAddress:r,debtChange:a,balance:n,availableUSDCollateral:o})=>{const[s,i]=(0,f.useReducer)(b.I,b.E),{data:l}=(0,y.a)(),{data:c}=(0,j.a)(),{data:d}=(0,I.L)(),p=(0,v.mx)(),{network:u}=(0,v.LN)(),{gasSpeed:h}=(0,S.jU)(),g=(0,v.yL)(),E=(0,x.useMutation)({mutationFn:async()=>{if(!p||!u||!g)throw new Error("No signer or network");if(!(l&&t&&e&&r&&c&&d))return;if(!n)return;if(!o)return;if(a.eq(0))return;const s=a.abs(),f=s.sub(o);try{i({type:"prompting"});const a=f.lte(0)?void 0:l.populateTransaction.deposit(w.O$.from(e),c.address,f.toBN()),n=l.populateTransaction.burnUsd(w.O$.from(e),w.O$.from(t),r,s.toBN()),o=Promise.all([a,n].filter(C._)),y=await p.getAddress(),x=(0,T.$)(d,u.isTestnet).then((e=>(0,T.x)(y,d,e))),[v,b,S]=await Promise.all([o,(0,A.o)({provider:g}),x]),j=S.concat(v),I=await(0,k.dI)(u,j,"useRepay",l.interface),E=(0,m.F)({gasLimit:I.gasLimit,gasPrices:b,gasSpeed:h}),P=await p.sendTransaction({...I,...E});i({type:"pending",payload:{txnHash:P.hash}}),await P.wait(),i({type:"success"})}catch(e){throw i({type:"error",payload:{error:e}}),e}}});return{mutation:E,txnState:s,settle:()=>i({type:"settled"}),isLoading:E.isPending,exec:E.mutateAsync}})({accountId:n.accountId,poolId:n.poolId,collateralTypeAddress:c?.tokenAddress,debtChange:a,availableUSDCollateral:r,balance:d}),{exec:U,settle:$}=(({accountId:e,poolId:t,collateralTypeAddress:r,debtChange:a,availableUSDCollateral:n})=>{const[o,s]=(0,f.useReducer)(b.I,b.E),{data:i}=(0,y.a)(),{data:l}=(0,j.a)(),{data:c}=(0,te.b)(),{data:d}=(0,ne.Y)(),{data:p}=(0,oe.X)(),u=(0,v.mx)(),{network:h}=(0,v.LN)(),{gasSpeed:g}=(0,S.jU)(),I=(0,v.yL)(),T=(0,x.useMutation)({mutationFn:async()=>{if(!u||!h||!I)throw new Error("No signer or network");if(!(i&&t&&e&&r&&l&&c&&p?.sUSD))return;if(!n)return;if(a.eq(0))return;const o=a.abs(),f=o.sub(n),y=f.gt(0)?(0,ae.vz)(f.toString(),6):w.O$.from(0);try{s({type:"prompting"});const a=f.gt(0)?c.populateTransaction.wrap(re.Ds,y,0):void 0,n=p?.sUSD,x=new J.CH(n,O.P,u),v=f.gt(0)?x.populateTransaction.approve(c.address,f.toBN()):void 0,b=f.gt(0)?c.populateTransaction.sell(re.Ds,f.toBN(),0,ee.d):void 0,S=new J.CH(l.address,O.P,u),j=f.gt(0)?S.populateTransaction.approve(i.address,f.toBN()):void 0,T=f.lte(0)?void 0:i.populateTransaction.deposit(w.O$.from(e),l.address,f.toBN()),E=i.populateTransaction.burnUsd(w.O$.from(e),w.O$.from(t),r,o.toBN()),P=Promise.all([a,v,b,j,T,E].filter(C._)),[R,D]=await Promise.all([P,(0,A.o)({provider:I})]);d&&R.push(d);const N=await(0,k.dI)(h,R,"useRepay",i.interface),L=(0,m.F)({gasLimit:N.gasLimit,gasPrices:D,gasSpeed:g}),U=await u.sendTransaction({...N,...L});s({type:"pending",payload:{txnHash:U.hash}}),await U.wait(),s({type:"success"})}catch(e){throw s({type:"error",payload:{error:e}}),e}}});return{mutation:T,txnState:o,settle:()=>s({type:"settled"}),isLoading:T.isPending,exec:T.mutateAsync}})({accountId:n.accountId,poolId:n.poolId,collateralTypeAddress:c?.tokenAddress,debtChange:a,availableUSDCollateral:r}),F=(0,p.p)({isClosable:!0,duration:9e3}),{data:H}=(0,y.a)(),{data:Y}=(0,te.b)(),Q=(0,D.o)(H),W=a.abs().sub(r||0),V=(0,re.Yz)(o?.id,o?.preset)?s?.USDC:l?.address,{approve:le,requireApproval:ce}=(0,O.y)({contractAddress:V,amount:(0,re.Yz)(o?.id,o?.preset)?(0,ae.vz)(W.toString(),6):W.toBN(),spender:(0,re.Yz)(o?.id,o?.preset)?Y?.address:H?.address}),[de,pe]=(0,L.e)(G,{services:{[X]:async()=>{try{F({title:"Approve sUSD for transfer",description:"The next transaction will repay your debt.",status:"info"}),await le(Boolean(de.context.infiniteApproval))}catch(e){const t=Q(e);throw t&&console.error(new Error(t.name),t),F.closeAll(),F({title:"Approval failed",description:t?(0,se.jsx)(g.M,{contractError:t}):"Please try again.",status:"error"}),Error("Approve failed",{cause:e})}},[Z]:async()=>{try{F.closeAll(),F({title:"Repaying..."}),(0,re.Yz)(o?.id,o?.preset)?await U():await u(),await Promise.all([i.invalidateQueries({queryKey:[`${o?.id}-${o?.preset}`,"TokenBalance"]}),i.invalidateQueries({queryKey:[`${o?.id}-${o?.preset}`,"Allowance"]}),i.invalidateQueries({queryKey:[`${o?.id}-${o?.preset}`,"LiquidityPosition"]})]),F.closeAll(),F({title:"Success",description:"Your debt has been repaid.",status:"success",duration:5e3})}catch(e){const t=Q(e);throw t&&console.error(new Error(t.name),t),F({title:"Could not complete repaying",description:t?(0,se.jsx)(g.M,{contractError:t}):"Please try again.",status:"error"}),Error("Repay failed",{cause:e})}}}}),ue=W.gt(0);(0,f.useEffect)((()=>{pe(q,{requireApproval:ce&&ue})}),[ue,ce,pe]);const he=(0,f.useCallback)((async()=>{if(de.matches(K))return pe(B),void e();de.context.error?pe(z):pe(M)}),[e,pe,de]);return n.poolId&&n.accountId&&c?(0,se.jsx)(ie,{state:de,onSubmit:he,debtChange:a,setInfiniteApproval:e=>{pe(_,{infiniteApproval:e})},onClose:()=>{h(),$(),e()},isOpen:t}):null},ce=le},97721:(e,t,r)=>{r.d(t,{o:()=>c});r(5875),r(50509),r(38728),r(64810),r(43419),r(32825),r(16093),r(77829),r(60253),r(49225),r(79941),r(57265),r(25888),r(15840),r(37610),r(13351);var a=r(79155),n=r(50986),o=r(10528),s=r(49494),i=r(2784),l=r(860);function c(e){return(0,i.useCallback)((t=>{if(e)try{const r=t?.error?.data?.data||t?.error?.error?.data;if(!r)return void console.error({error:t});const i=e.interface.format(a.pc.full),c=new n.CH(e.address,Array.from(new Set(i.concat(l.IN).concat(["error CannotSelfApprove(address addr)","error InvalidTransferRecipient(address addr)","error InvalidOwner(address addr)","error TokenDoesNotExist(uint256 id)","error TokenAlreadyMinted(uint256 id)"]))),e.signer||e.provider).interface.parseError(r),d=Object.fromEntries(Object.entries(c.args).filter((([e])=>`${parseInt(e)}`!==e)).map((([e,t])=>{if(t instanceof o.O$){const r=parseFloat(s.dF(t.toString()));return r>.001?[e,r]:t.toNumber()>new Date(2e3,1,1).getTime()/1e3&&t.toNumber()<new Date(2100,1,1).getTime()/1e3?[e,new Date(1e3*t.toNumber())]:[e,parseFloat(t.toString())]}return[e,t]})));return{data:r,name:c.name,signature:c.signature,args:d}}catch(e){return void console.error(e)}}),[e])}}}]);
//# sourceMappingURL=2899.d5f3660a.js.map